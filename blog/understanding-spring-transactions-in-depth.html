<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
<script type="text/javascript">
    var host = "zhuxingsheng.github.io";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location = window.location.toString().replace(/^http:/, "https:");
</script>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <meta name="baidu-site-verification" content="MXFRoVpC6c" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="spring,事务," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="前言这篇其实也要归纳到《常识》系列中，但这重点又是spring的介绍，故归档在spring系列中。 工作很多年，除了学生时代学过，事务还真没有用过。过去开发游戏时，完全不用事务；现在互联网开发，也没有使用事务的场景，不要见怪。 概念对于事务(Transaction)的概念，网上有各种版本，大同小异， 事务就是是由一系列对系统中数据进行读写的操作组成的一个程序执行单元，狭义上的事务特指数据库事务。">
<meta name="keywords" content="spring,事务">
<meta property="og:type" content="article">
<meta property="og:title" content="深入浅出spring事务">
<meta property="og:url" content="http://blog.zhuxingsheng.com/blog/understanding-spring-transactions-in-depth.html">
<meta property="og:site_name" content="码农戏码">
<meta property="og:description" content="前言这篇其实也要归纳到《常识》系列中，但这重点又是spring的介绍，故归档在spring系列中。 工作很多年，除了学生时代学过，事务还真没有用过。过去开发游戏时，完全不用事务；现在互联网开发，也没有使用事务的场景，不要见怪。 概念对于事务(Transaction)的概念，网上有各种版本，大同小异， 事务就是是由一系列对系统中数据进行读写的操作组成的一个程序执行单元，狭义上的事务特指数据库事务。">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/data.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/lostupdate.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/dirtyread.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/phantomread.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/unrepeatedread.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/secondlostupdates.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/isolation.jpg">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/isolation-phr.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/transaction.jpg">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/transaction_1.jpg">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/spring-interface.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/spring-txmanager.jpg">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/spring-attribute.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/propagation.png">
<meta property="og:image" content="http://qnimages.zhuxingsheng.com/transaction/readonly.JPG">
<meta property="og:updated_time" content="2018-11-22T13:04:17.771Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入浅出spring事务">
<meta name="twitter:description" content="前言这篇其实也要归纳到《常识》系列中，但这重点又是spring的介绍，故归档在spring系列中。 工作很多年，除了学生时代学过，事务还真没有用过。过去开发游戏时，完全不用事务；现在互联网开发，也没有使用事务的场景，不要见怪。 概念对于事务(Transaction)的概念，网上有各种版本，大同小异， 事务就是是由一系列对系统中数据进行读写的操作组成的一个程序执行单元，狭义上的事务特指数据库事务。">
<meta name="twitter:image" content="http://qnimages.zhuxingsheng.com/transaction/data.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.zhuxingsheng.com/blog/understanding-spring-transactions-in-depth.html"/>




  <title> 深入浅出spring事务 | 码农戏码 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?48897be5dd7a377cc247d8870a476fb8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">码农戏码</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://blog.zhuxingsheng.com/blog/understanding-spring-transactions-in-depth.html">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="朱兴生">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/6222636?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="码农戏码">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="码农戏码" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                深入浅出spring事务
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-11T21:24:00+08:00">
                2017-07-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/source/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          
	
	  
	  <span class="post-letters-count">
	    &nbsp; | &nbsp;
	    <span>9.4k 字</span>
	    &nbsp; | &nbsp;
	    <span>37 min</span>
	  </span>
	  

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这篇其实也要归纳到《常识》系列中，但这重点又是spring的介绍，故归档在spring系列中。</p>
<p>工作很多年，除了学生时代学过，事务还真没有用过。过去开发游戏时，完全不用事务；现在互联网开发，也没有使用事务的场景，不要见怪。</p>
<h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><p>对于事务(Transaction)的概念，网上有各种版本，大同小异，</p>
<p>事务就是是由一系列对系统中数据进行读写的操作组成的一个程序执行单元，狭义上的事务特指数据库事务。</p>
<p>事务是一系列的动作，它们综合在一起才是一个完整的工作单元，这些动作必须全部完成，如果有一个失败的话，那么事务就会回滚到最开始的状态，仿佛什么都没发生过一样。 </p>
<p>在企业级应用程序开发中，事务管理必不可少的技术，用来确保数据的完整性和一致性。 </p>
<p>比如你去ATM机取1000块钱，大体有两个步骤：首先输入密码金额，银行卡扣掉1000元钱；然后ATM出1000元钱。这两个步骤必须是要么都执行要么都不执行。如果银行卡扣除了1000块但是ATM出钱失败的话，你将会损失1000元；如果银行卡扣钱失败但是ATM却出了1000块，那么银行将损失1000元。所以，如果一个步骤成功另一个步骤失败对双方都不是好事，如果不管哪一个步骤失败了以后，整个取钱过程都能回滚，也就是完全取消所有操作的话，这对双方都是极好的。 </p>
<h2 id="事务的特性"><a href="#事务的特性" class="headerlink" title="事务的特性"></a>事务的特性</h2><p>大名鼎鼎的ACID</p>
<ol>
<li>原子性（Atomicity），事务必须是一个原子的操作序列单元，一次事务只允许存在两种状态，全部成功或全部失败，任何一个操作失败都将导致整个事务失败</li>
<li>一致性（Consistency），事务的执行不能破坏系统数据的完整性和一致性，如果未完成的事务对系统数据的修改有一部分已经写入物理数据库，这时系统数据就处于不一致状态</li>
<li>隔离性（Isolation），在并发环境中，不同的事务操作相同的数据时，虚相互隔离不能相互干扰</li>
<li>持久性（Durability），事务一旦提交，对系统数据的变更就应该是永久的，必须被永久保存下来，即使服务器宕机了，只要数据库能够重新启动，就一定能够恢复到事务成功结束时的状态</li>
</ol>
<h2 id="事务并发处理问题"><a href="#事务并发处理问题" class="headerlink" title="事务并发处理问题"></a>事务并发处理问题</h2><p>如果没有锁定且多个用户同时访问一个数据库，则当他们的事务同时使用相同的数据时可能会发生问题。由于并发操作带来的数据不一致性包括：丢失数据修改、读”脏”数据（脏读）、不可重复读、产生幽灵数据：</p>
<p>假设数据库中有如下一张表：</p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/data.png" alt="image"></p>
<h3 id="第一类丢失更新-lost-update"><a href="#第一类丢失更新-lost-update" class="headerlink" title="第一类丢失更新(lost update)"></a>第一类丢失更新(lost update)</h3><p><strong>回滚丢失</strong></p>
<p>在完全未隔离事务的情况下，两个事物更新同一条数据资源，某一事物异常终止，回滚造成第一个完成的更新也同时丢失。<br><img src="http://qnimages.zhuxingsheng.com/transaction/lostupdate.png" alt="image"></p>
<p>在T1时刻开启了事务1，T2时刻开启了事务2，</p>
<p>在T3时刻事务1从数据库中取出了id=”402881e535194b8f0135194b91310001”的数据，</p>
<p>T4时刻事务2取出了同一条数据，</p>
<p>T5时刻事务1将age字段值更新为30，</p>
<p>T6时刻事务2更新age为35并提交了数据，</p>
<p>但是T7事务1回滚了事务age最后的值依然为20，事务2的更新丢失了，</p>
<p>这种情况就叫做”第一类丢失更新(lost update)”。</p>
<h3 id="脏读-dirty-read"><a href="#脏读-dirty-read" class="headerlink" title="脏读(dirty read)"></a>脏读(dirty read)</h3><p><strong>事务没提交，提前读取</strong></p>
<p>如果第二个事务查询到第一个事务还未提交的更新数据，形成脏读<br><img src="http://qnimages.zhuxingsheng.com/transaction/dirtyread.png" alt="image"></p>
<p>在T1时刻开启了事务1，T2时刻开启了事务2，</p>
<p>在T3时刻事务1从数据库中取出了id=”402881e535194b8f0135194b91310001”的数据，</p>
<p>在T5时刻事务1将age的值更新为30，但是事务还未提交，</p>
<p>T6时刻事务2读取同一条记录，获得age的值为30，但是事务1还未提交，</p>
<p>若在T7时刻事务1回滚了事务2的数据就是错误的数据(脏数据)，</p>
<p>这种情况叫做” 脏读(dirty read)”。</p>
<h3 id="虚读-phantom-read"><a href="#虚读-phantom-read" class="headerlink" title="虚读(phantom read)"></a>虚读(phantom read)</h3><p>一个事务执行两次查询，第二次结果集包含第一次中没有或者某些行已被删除，造成两次结果不一致，只是另一个事务在这两次查询中间插入或者删除了数据造成的</p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/phantomread.png" alt="image"></p>
<p>在T1时刻开启了事务1，T2时刻开启了事务2，</p>
<p>T3时刻事务1从数据库中查询所有记录，记录总共有一条，</p>
<p>T4时刻事务2向数据库中插入一条记录，T6时刻事务2提交事务。</p>
<p>T7事务1再次查询数据数据时，记录变成两条了。</p>
<p>这种情况是”虚读(phantom read)”。</p>
<h3 id="不可重复读-unrepeated-read"><a href="#不可重复读-unrepeated-read" class="headerlink" title="不可重复读(unrepeated read)"></a>不可重复读(unrepeated read)</h3><p>一个事务两次读取同一行数据，结果得到不同状态结果，如中间正好另一个事务更新了该数据，两次结果相异，不可信任<br><img src="http://qnimages.zhuxingsheng.com/transaction/unrepeatedread.png" alt="image"></p>
<p>在T1时刻开启了事务1，T2时刻开启了事务2，</p>
<p>在T3时刻事务1从数据库中取出了id=”402881e535194b8f0135194b91310001”的数据，此时age=20，</p>
<p>T4时刻事务2查询同一条数据，</p>
<p>T5事务2更新数据age=30，T6时刻事务2提交事务，</p>
<p>T7事务1查询同一条数据，发现数据与第一次不一致。</p>
<p>这种情况就是”不可重复读(unrepeated read)”</p>
<h3 id="第二类丢失更新-second-lost-updates"><a href="#第二类丢失更新-second-lost-updates" class="headerlink" title="第二类丢失更新(second lost updates)"></a>第二类丢失更新(second lost updates)</h3><p><strong>覆盖丢失</strong></p>
<p>不可重复读的特殊情况，如果两个事务都读取同一行，然后两个都进行写操作，并提交，第一个事务所做的改变就会丢失。</p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/secondlostupdates.png" alt="image"></p>
<p>在T1时刻开启了事务1，T2时刻开启了事务2，</p>
<p>T3时刻事务1更新数据age=25，</p>
<p>T5时刻事务2更新数据age=30，</p>
<p>T6时刻提交事务，</p>
<p>T7时刻事务2提交事务，把事务1的更新覆盖了。</p>
<p>这种情况就是”第二类丢失更新(second lost updates)”。</p>
<h2 id="并发问题总结"><a href="#并发问题总结" class="headerlink" title="并发问题总结"></a>并发问题总结</h2><p>不可重复读的重点是修改 : </p>
<p>同样的条件 ,   你读取过的数据 ,   再次读取出来发现值不一样了 </p>
<p>幻读的重点在于新增或者删除 </p>
<p>同样的条件 ,   第 1 次和第 2 次读出来的记录数不一样 </p>
<p>第一类更新丢失(回滚丢失)</p>
<p>第二类更新丢失(覆盖丢失)</p>
<h2 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h2><p>解决并发问题的途径是什么?答案是：采取有效的隔离机制。怎样实现事务的隔离呢？隔离机制的实现必须使用锁</p>
<p>一般在编程的时候只需要设置隔离等级</p>
<p>数据库系统提供四种事务隔离级别：</p>
<ol>
<li>未提交读（READ UNCOMMITTED ）</li>
</ol>
<p>最低隔离级别，一个事务能读取到别的事务未提交的更新数据，很不安全，可能出现丢失更新、脏读、不可重复读、幻读；</p>
<ol start="2">
<li>提交读（READ COMMITTED）</li>
</ol>
<p>一个事务能读取到别的事务提交的更新数据，不能看到未提交的更新数据，不会出现丢失更新、脏读，但可能出现不可重复读、幻读；</p>
<ol start="3">
<li>可重复读（REPEATABLE READ）</li>
</ol>
<p>保证同一事务中先后执行的多次查询将返回同一结果，不受其他事务影响，不可能出现丢失更新、脏读、不可重复读，但可能出现幻读；</p>
<ol start="4">
<li>序列化（SERIALIZABLE）</li>
</ol>
<p>最高隔离级别，不允许事务并发执行，而必须串行化执行，最安全，不可能出现更新、脏读、不可重复读、幻读，但是效率最低。</p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/isolation.jpg" alt="image"></p>
<p>隔离级别越高，数据库事务并发执行性能越差，能处理的操作越少。<br>所以一般地，推荐使用REPEATABLE READ级别保证数据的读一致性。<br>对于幻读的问题，可以通过加锁来防止</p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/isolation-phr.png" alt="image"></p>
<p>MySQL支持这四种事务等级，默认事务隔离级别是REPEATABLE READ。</p>
<p>Oracle数据库支持READ COMMITTED 和 SERIALIZABLE这两种事务隔离级别，<br>所以Oracle数据库不支持脏读</p>
<p>Oracle数据库默认的事务隔离级别是READ COMMITTED</p>
<p>不可重复读和幻读的区别是，不可重复读对应的表的操作是更改(UPDATE)，而幻读对应的表的操作是插入(INSERT)，两种的应对策略不一样。对于不可重复读，只需要采用行级锁防止该记录被更新即可，而对于幻读必须加个表级锁，防止在表中插入数据</p>
<h3 id="锁"><a href="#锁" class="headerlink" title="锁"></a>锁</h3><h4 id="乐观锁-Optimistic-Lock-和悲观锁-Pessimistic-Lock"><a href="#乐观锁-Optimistic-Lock-和悲观锁-Pessimistic-Lock" class="headerlink" title="乐观锁(Optimistic Lock)和悲观锁(Pessimistic Lock)"></a>乐观锁(Optimistic Lock)和悲观锁(Pessimistic Lock)</h4><p>最重要的分类就是乐观锁(Optimistic Lock)和悲观锁(Pessimistic Lock)，这实际上是两种锁策略</p>
<p><strong>乐观锁</strong>，顾名思义就是非常乐观，非常相信真善美，每次去读数据都认为其它事务没有在写数据，所以就不上锁，快乐的读取数据，而只在提交数据的时候判断其它事务是否搞过这个数据了，如果搞过就rollback。乐观锁相当于一种检测冲突的手段，可通过为记录添加版本或添加时间戳来实现。</p>
<p><strong>悲观锁</strong>，对其它事务抱有保守的态度，每次去读数据都认为其它事务想要作祟，所以每次读数据的时候都会上锁，直到取出数据。悲观锁大多数情况下依靠数据库的锁机制实现，以保证操作最大程度的独占性，但随之而来的是各种开销。悲观锁相当于一种避免冲突的手段。</p>
<p><em>选择标准</em>：如果并发量不大，或数据冲突的后果不严重，则可以使用乐观锁；而如果并发量大或数据冲突后果比较严重（对用户不友好），那么就使用悲观锁。</p>
<h4 id="分共享锁（S锁，Shared-Lock）和排他锁（X锁，Exclusive-Lock）"><a href="#分共享锁（S锁，Shared-Lock）和排他锁（X锁，Exclusive-Lock）" class="headerlink" title="分共享锁（S锁，Shared Lock）和排他锁（X锁，Exclusive Lock）"></a>分共享锁（S锁，Shared Lock）和排他锁（X锁，Exclusive Lock）</h4><p>从读写角度，分共享锁（S锁，Shared Lock）和排他锁（X锁，Exclusive Lock），也叫读锁（Read Lock）和写锁（Write Lock）。<br>理解：</p>
<p>持有S锁的事务只读不可写。</p>
<p>如果事务A对数据D加上S锁后，其它事务只能对D加上S锁而不能加X锁。</p>
<p>持有X锁的事务可读可写。</p>
<p>如果事务A对数据D加上X锁后，其它事务不能再对D加锁，直到A对D的锁解除。</p>
<h4 id="表级锁（Table-Lock）和行级锁（Row-Lock）"><a href="#表级锁（Table-Lock）和行级锁（Row-Lock）" class="headerlink" title="表级锁（Table Lock）和行级锁（Row Lock）"></a>表级锁（Table Lock）和行级锁（Row Lock）</h4><p>从锁的粒度角度，主要分为表级锁（Table Lock）和行级锁（Row Lock）。</p>
<p>表级锁将整个表加锁，性能开销最小</p>
<p>用户可以同时进行读操作。当一个用户对表进行写操作时，用户可以获得一个写锁，写锁禁止其他的用户读写操作。写锁比读锁的优先级更高，即使有读操作已排在队列中，一个被申请的写锁仍可以排在所队列的前列。</p>
<p>行级锁仅对指定的记录进行加锁</p>
<p>这样其它进程可以对同一个表中的其它记录进行读写操作。行级锁粒度最小，开销大，能够支持高并发，可能会出现死锁。</p>
<p>MySQL的MyISAM引擎使用表级锁，而InnoDB支持表级锁和行级锁，默认是行级锁。<br>还有BDB引擎使用页级锁，即一次锁定一组记录，并发性介于行级锁和表级锁之间。</p>
<h4 id="三级锁协议"><a href="#三级锁协议" class="headerlink" title="三级锁协议"></a>三级锁协议</h4><p>三级加锁协议是为了保证正确的事务并发操作，事务在读、写数据库对象是需要遵循的加锁规则。</p>
<p>一级封锁协议：事务T在修改数据R之前必须对它加X锁，直到事务结束方可释放。而若事务T只是读数据，不进行修改，则不需加锁，因此一级加锁协议下可能会出现脏读和不可重复读。</p>
<p>二级加锁协议：在一级加锁协议的基础上，加上这样一条规则——事务T在读取数据R之前必须对它加S锁，直到读取完毕以后释放。二级加锁协议下可能会出现不可重复读。</p>
<p>三级加锁协议：在一级加锁协议的基础上，加上这样一条规则——事务T在读取数据R之前必须对它加S锁，直到事务结束方可释放。三级加锁协议避免了脏读和不可重复读的问题</p>
<h1 id="Spring事务"><a href="#Spring事务" class="headerlink" title="Spring事务"></a>Spring事务</h1><p>Spring事务管理的实现有许多细节，如果对整个接口框架有个大体了解会非常有利于我们理解事务</p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/transaction.jpg" alt="image"></p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/transaction_1.jpg" alt="image"></p>
<h2 id="Spring事务管理器"><a href="#Spring事务管理器" class="headerlink" title="Spring事务管理器"></a>Spring事务管理器</h2><p>Spring事务管理涉及的接口的联系如下：<br><img src="http://qnimages.zhuxingsheng.com/transaction/spring-interface.png" alt="image"></p>
<p>Spring并不直接管理事务，而是提供了多种事务管理器，他们将事务管理的职责委托给Hibernate或者JTA等持久化机制所提供的相关平台框架的事务来实现。 </p>
<p>Spring事务管理器的接口是org.springframework.transaction.PlatformTransactionManager，<br>通过这个接口，Spring为各个平台如JDBC、Hibernate等都提供了对应的事务管理器，</p>
<p>但是具体的实现就是各个平台自己的事情了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * This is the central interface in Spring&apos;s transaction infrastructure.</span><br><span class="line"> * Applications can use this directly, but it is not primarily meant as API:</span><br><span class="line"> * Typically, applications will work with either TransactionTemplate or</span><br><span class="line"> * declarative transaction demarcation through AOP.</span><br><span class="line"> */</span><br><span class="line">public interface PlatformTransactionManager &#123;</span><br><span class="line">    TransactionStatus getTransaction(TransactionDefinition definition)</span><br><span class="line">        throws TransactionException;</span><br><span class="line">    void commit(TransactionStatus status) throws TransactionException;</span><br><span class="line">    void rollback(TransactionStatus status) throws TransactionException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>标准的jdbc处理事务代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Connection conn = DataSourceUtils.getConnection();</span><br><span class="line"> //开启事务</span><br><span class="line">conn.setAutoCommit(false);</span><br><span class="line">try &#123;</span><br><span class="line">    Object retVal = callback.doInConnection(conn);</span><br><span class="line">    conn.commit(); //提交事务</span><br><span class="line">    return retVal;</span><br><span class="line">&#125;catch (Exception e) &#123;</span><br><span class="line">    conn.rollback();//回滚事务</span><br><span class="line">    throw e;</span><br><span class="line">&#125;finally &#123;</span><br><span class="line">    conn.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>spring对应的TranstactionTemplate处理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public class TransactionTemplate extends DefaultTransactionDefinition</span><br><span class="line">		implements TransactionOperations, InitializingBean &#123;</span><br><span class="line">		</span><br><span class="line">    @Override</span><br><span class="line">	public &lt;T&gt; T execute(TransactionCallback&lt;T&gt; action) throws TransactionException &#123;</span><br><span class="line">		if (this.transactionManager instanceof CallbackPreferringPlatformTransactionManager) &#123;</span><br><span class="line">			return ((CallbackPreferringPlatformTransactionManager) this.transactionManager).execute(this, action);</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			TransactionStatus status = this.transactionManager.getTransaction(this);</span><br><span class="line">			T result;</span><br><span class="line">			try &#123;</span><br><span class="line">				result = action.doInTransaction(status);</span><br><span class="line">			&#125;</span><br><span class="line">			catch (RuntimeException ex) &#123;</span><br><span class="line">				// Transactional code threw application exception -&gt; rollback</span><br><span class="line">				rollbackOnException(status, ex);</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Error err) &#123;</span><br><span class="line">				// Transactional code threw error -&gt; rollback</span><br><span class="line">				rollbackOnException(status, err);</span><br><span class="line">				throw err;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Exception ex) &#123;</span><br><span class="line">				// Transactional code threw unexpected exception -&gt; rollback</span><br><span class="line">				rollbackOnException(status, ex);</span><br><span class="line">				throw new UndeclaredThrowableException(ex, &quot;TransactionCallback threw undeclared checked exception&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">			this.transactionManager.commit(status);</span><br><span class="line">			return result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>具体的事务管理机制对Spring来说是透明的，它并不关心那些，那些是对应各个平台需要关心的，所以Spring事务管理的一个优点就是为不同的事务API提供一致的编程模型，如JTA、JDBC、Hibernate、JPA。下面分别介绍各个平台框架实现事务管理的机制。</p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/spring-txmanager.jpg" alt="image"></p>
<h3 id="JDBC事务"><a href="#JDBC事务" class="headerlink" title="JDBC事务"></a>JDBC事务</h3><p>如果应用程序中直接使用JDBC来进行持久化，DataSourceTransactionManager会为你处理事务边界。为了使用DataSourceTransactionManager，你需要使用如下的XML将其装配到应用程序的上下文定义中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;dataSource&quot; ref=&quot;dataSource&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></p>
<p>实际上，DataSourceTransactionManager是通过调用java.sql.Connection来管理事务，而后者是通过DataSource获取到的。通过调用连接的commit()方法来提交事务，同样，事务失败则通过调用rollback()方法进行回滚。</p>
<h3 id="Hibernate事务"><a href="#Hibernate事务" class="headerlink" title="Hibernate事务"></a>Hibernate事务</h3><p>如果应用程序的持久化是通过Hibernate实习的，那么你需要使用HibernateTransactionManager。对于Hibernate3，需要在Spring上下文定义中添加如下的<bean>声明：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id=&quot;transactionManager&quot; class=&quot;org.springframework.orm.hibernate3.HibernateTransactionManager&quot;&gt;</span><br><span class="line">    &lt;property name=&quot;sessionFactory&quot; ref=&quot;sessionFactory&quot; /&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure></bean></p>
<p>sessionFactory属性需要装配一个Hibernate的session工厂，HibernateTransactionManager的实现细节是它将事务管理的职责委托给org.hibernate.Transaction对象，而后者是从Hibernate Session中获取到的。当事务成功完成时，HibernateTransactionManager将会调用Transaction对象的commit()方法，反之，将会调用rollback()方法。</p>
<h2 id="事务属性"><a href="#事务属性" class="headerlink" title="事务属性"></a>事务属性</h2><p>事务管理器接口PlatformTransactionManager通过getTransaction(TransactionDefinition definition)方法来得到事务，这个方法里面的参数是TransactionDefinition类，这个类就定义了一些基本的事务属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public interface TransactionDefinition &#123;</span><br><span class="line">    int getPropagationBehavior(); // 返回事务的传播行为</span><br><span class="line">    int getIsolationLevel(); // 返回事务的隔离级别，事务管理器根据它来控制另外一个事务可以看到本事务内的哪些数据</span><br><span class="line">    int getTimeout();  // 返回事务必须在多少秒内完成</span><br><span class="line">    boolean isReadOnly(); // 事务是否只读，事务管理器能够根据这个返回值进行优化，确保事务是只读的</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么什么是事务属性呢？事务属性可以理解成事务的一些基本配置，描述了事务策略如何应用到方法上。事务属性包含了5个方面</p>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/spring-attribute.png" alt="image"></p>
<h3 id="传播行为"><a href="#传播行为" class="headerlink" title="传播行为"></a>传播行为</h3><p>事务的第一个方面是传播行为（propagation behavior）。<br>当事务方法被另一个事务方法调用时，必须指定事务应该如何传播。</p>
<p>为什么需要定义传播？</p>
<blockquote>
<p>在我们用SSH开发项目的时候，我们一般都是将事务设置在Service层 那么当我们调用Service层的一个方法的时候它能够保证我们的这个方法中执行的所有的对数据库的更新操作保持在一个事务中，在事务层里面调用的这些方法要么全部成功，要么全部失败。那么事务的传播特性也是从这里说起的。<br>如果你在你的Service层的这个方法中，除了调用了Dao层的方法之外，还调用了本类的其他的Service方法，那么在调用其他的Service方法的时候，这个事务是怎么规定的呢，我必须保证我在我方法里掉用的这个方法与我本身的方法处在同一个事务中，否则如果保证事物的一致性。事务的传播特性就是解决这个问题的，“事务是会传播的”在Spring中有针对传播特性的多种配置我们大多数情况下只用其中的一种:PROPGATION_REQUIRED：这个配置项的意思是说当我调用service层的方法的时候开启一个事务(具体调用那一层的方法开始创建事务，要看你的aop的配置),那么在调用这个service层里面的其他的方法的时候,如果当前方法产生了事务就用当前方法产生的事务，否则就创建一个新的事务。这个工作使由Spring来帮助我们完成的。<br>以前没有Spring帮助我们完成事务的时候我们必须自己手动的控制事务，例如当我们项目中仅仅使用hibernate，而没有集成进spring的时候，我们在一个service层中调用其他的业务逻辑方法，为了保证事物必须也要把当前的hibernate session传递到下一个方法中，或者采用ThreadLocal的方法，将session传递给下一个方法，其实都是一个目的。现在这个工作由spring来帮助我们完成，就可以让我们更加的专注于我们的业务逻辑。而不用去关心事务的问题。</p>
</blockquote>
<p>Spring定义了七种传播行为：</p>
<p>PROPAGATION_REQUIRED</p>
<p>如果当前没有事务，就新建一个事务，如果已经存在一个事务中，加入到这个事务中。这是最常见的选择。</p>
<p>PROPAGATION_SUPPORTS</p>
<p>支持当前事务，如果当前没有事务，就以非事务方式执行。</p>
<p>PROPAGATION_MANDATORY</p>
<p>使用当前的事务，如果当前没有事务，就抛出异常。</p>
<p>PROPAGATION_REQUIRES_NEW</p>
<p>新建事务，如果当前存在事务，把当前事务挂起。</p>
<p>PROPAGATION_NOT_SUPPORTED</p>
<p>以非事务方式执行操作，如果当前存在事务，就把当前事务挂起。</p>
<p>PROPAGATION_NEVER</p>
<p>以非事务方式执行，如果当前存在事务，则抛出异常。</p>
<p>PROPAGATION_NESTED</p>
<p>如果当前存在事务，则在嵌套事务内执行。如果当前没有事务，则执行与PROPAGATION_REQUIRED类似的操作。</p>
<h4 id="传播行为详细"><a href="#传播行为详细" class="headerlink" title="传播行为详细"></a>传播行为详细</h4><p>通过实例尝试一下各个传播属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ServiceA &#123;</span><br><span class="line">       </span><br><span class="line">     void methodA() &#123;</span><br><span class="line">         ServiceB.methodB();</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">ServiceB &#123;</span><br><span class="line">       </span><br><span class="line">     void methodB() &#123;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="PROPAGATION-REQUIRED"><a href="#PROPAGATION-REQUIRED" class="headerlink" title="PROPAGATION_REQUIRED"></a>PROPAGATION_REQUIRED</h5><p>如果存在一个事务，则支持当前事务。如果没有事务则开启一个新的事务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//事务属性 PROPAGATION_REQUIRED</span><br><span class="line">methodA&#123;</span><br><span class="line">    ……</span><br><span class="line">    methodB();</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br><span class="line">//事务属性 PROPAGATION_REQUIRED</span><br><span class="line">methodB&#123;</span><br><span class="line">   ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单独调用methodB方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main&#123; </span><br><span class="line">    metodB(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相当于<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Main&#123; </span><br><span class="line">    Connection con=null; </span><br><span class="line">    try&#123; </span><br><span class="line">        con = getConnection(); </span><br><span class="line">        con.setAutoCommit(false); </span><br><span class="line"></span><br><span class="line">        //方法调用</span><br><span class="line">        methodB(); </span><br><span class="line"></span><br><span class="line">        //提交事务</span><br><span class="line">        con.commit(); </span><br><span class="line">    &#125; Catch(RuntimeException ex) &#123; </span><br><span class="line">        //回滚事务</span><br><span class="line">        con.rollback();   </span><br><span class="line">    &#125; finally &#123; </span><br><span class="line">        //释放资源</span><br><span class="line">        closeCon(); </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Spring保证在methodB方法中所有的调用都获得到一个相同的连接。在调用methodB时，没有一个存在的事务，所以获得一个新的连接，开启了一个新的事务。 </p>
<p><strong>只是在ServiceB.methodB内的任何地方出现异常，ServiceB.methodB将会被回滚，不会引起ServiceA.methodA的回滚</strong></p>
<p>单独调用MethodA时，在MethodA内又会调用MethodB.</p>
<p>执行效果相当于：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">main&#123; </span><br><span class="line">    Connection con = null; </span><br><span class="line">    try&#123; </span><br><span class="line">        con = getConnection(); </span><br><span class="line">        methodA(); </span><br><span class="line">        con.commit(); </span><br><span class="line">    &#125; catch(RuntimeException ex) &#123; </span><br><span class="line">        con.rollback(); </span><br><span class="line">    &#125; finally &#123;    </span><br><span class="line">        closeCon(); </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用MethodA时，环境中没有事务，所以开启一个新的事务.</p>
<p>当在MethodA中调用MethodB时，环境中已经有了一个事务，所以methodB就加入当前事务</p>
<p><strong>ServiceA.methodA或者ServiceB.methodB无论哪个发生异常methodA和methodB作为一个整体都将一起回滚</strong></p>
<h5 id="PROPAGATION-SUPPORTS"><a href="#PROPAGATION-SUPPORTS" class="headerlink" title="PROPAGATION_SUPPORTS"></a>PROPAGATION_SUPPORTS</h5><p>如果存在一个事务，支持当前事务。如果没有事务，则非事务的执行。但是对于事务同步的事务管理器，PROPAGATION_SUPPORTS与不使用事务有少许不同<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//事务属性 PROPAGATION_REQUIRED</span><br><span class="line">methodA()&#123;</span><br><span class="line">  methodB();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//事务属性 PROPAGATION_SUPPORTS</span><br><span class="line">methodB()&#123;</span><br><span class="line">  ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>单纯的调用methodB时，methodB方法是非事务的执行的。当调用methdA时,methodB则加入了methodA的事务中,事务地执行</p>
<h5 id="PROPAGATION-MANDATORY"><a href="#PROPAGATION-MANDATORY" class="headerlink" title="PROPAGATION_MANDATORY"></a>PROPAGATION_MANDATORY</h5><p>如果已经存在一个事务，支持当前事务。如果没有一个活动的事务，则抛出异常<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//事务属性 PROPAGATION_REQUIRED</span><br><span class="line">methodA()&#123;</span><br><span class="line">    methodB();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//事务属性 PROPAGATION_MANDATORY</span><br><span class="line">    methodB()&#123;</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当单独调用methodB时，因为当前没有一个活动的事务，则会抛出异常throw new IllegalTransactionStateException(“Transaction propagation ‘mandatory’ but no existing transaction found”);</p>
<p>当调用methodA时，methodB则加入到methodA的事务中，事务地执行</p>
<h5 id="PROPAGATION-REQUIRES-NEW"><a href="#PROPAGATION-REQUIRES-NEW" class="headerlink" title="PROPAGATION_REQUIRES_NEW"></a>PROPAGATION_REQUIRES_NEW</h5><p>总是开启一个新的事务。如果一个事务已经存在，则将这个存在的事务挂起。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//事务属性 PROPAGATION_REQUIRED</span><br><span class="line">methodA()&#123;</span><br><span class="line">    doSomeThingA();</span><br><span class="line">    methodB();</span><br><span class="line">    doSomeThingB();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//事务属性 PROPAGATION_REQUIRES_NEW</span><br><span class="line">methodB()&#123;</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调用A方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">    methodA();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>相当于<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">main()&#123;</span><br><span class="line">    TransactionManager tm = null;</span><br><span class="line">    try&#123;</span><br><span class="line">        //获得一个JTA事务管理器</span><br><span class="line">        tm = getTransactionManager();</span><br><span class="line">        tm.begin();//开启一个新的事务</span><br><span class="line">        Transaction ts1 = tm.getTransaction();</span><br><span class="line">        doSomeThing();</span><br><span class="line">        tm.suspend();//挂起当前事务</span><br><span class="line">        try&#123;</span><br><span class="line">            tm.begin();//重新开启第二个事务</span><br><span class="line">            Transaction ts2 = tm.getTransaction();</span><br><span class="line">            methodB();</span><br><span class="line">            ts2.commit();//提交第二个事务</span><br><span class="line">        &#125; Catch(RunTimeException ex) &#123;</span><br><span class="line">            ts2.rollback();//回滚第二个事务</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            //释放资源</span><br><span class="line">        &#125;</span><br><span class="line">        //methodB执行完后，恢复第一个事务</span><br><span class="line">        tm.resume(ts1);</span><br><span class="line">        doSomeThingB();</span><br><span class="line">        ts1.commit();//提交第一个事务</span><br><span class="line">    &#125; catch(RunTimeException ex) &#123;</span><br><span class="line">        ts1.rollback();//回滚第一个事务</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        //释放资源</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里，我把ts1称为外层事务，ts2称为内层事务。从上面的代码可以看出，ts2与ts1是两个独立的事务，互不相干。</p>
<p>Ts2是否成功并不依赖于ts1</p>
<p>如果methodA方法在调用methodB方法后的doSomeThingB方法失败了，而methodB方法所做的结果依然被提交。</p>
<p>而除了 methodB之外的其它代码导致的结果却被回滚了</p>
<h5 id="PROPAGATION-NOT-SUPPORTED"><a href="#PROPAGATION-NOT-SUPPORTED" class="headerlink" title="PROPAGATION_NOT_SUPPORTED"></a>PROPAGATION_NOT_SUPPORTED</h5><p>以非事务方式执行操作，如果当前存在事务，就把当前事务挂起,<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//事务属性 PROPAGATION_REQUIRED</span><br><span class="line">methodA()&#123;</span><br><span class="line">    doSomeThingA();</span><br><span class="line">    methodB();</span><br><span class="line">    doSomeThingB();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//事务属性 PROPAGATION_NOT_SUPPORTED</span><br><span class="line">methodB()&#123;</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当前不支持事务。比如ServiceA.methodA的事务级别是PROPAGATION_REQUIRED ，<br>而ServiceB.methodB的事务级别是PROPAGATION_NOT_SUPPORTED ，<br>那么当执行到ServiceB.methodB时，ServiceA.methodA的事务挂起，而他以非事务的状态运行完，再继续ServiceA.methodA的事务</p>
<h5 id="PROPAGATION-NEVER"><a href="#PROPAGATION-NEVER" class="headerlink" title="PROPAGATION_NEVER"></a>PROPAGATION_NEVER</h5><p>不能在事务中运行。假设ServiceA.methodA的事务级别是PROPAGATION_REQUIRED，<br>而ServiceB.methodB的事务级别是PROPAGATION_NEVER ，<br>那么ServiceB.methodB就要抛出异常了。</p>
<h5 id="PROPAGATION-NESTED"><a href="#PROPAGATION-NESTED" class="headerlink" title="PROPAGATION_NESTED"></a>PROPAGATION_NESTED</h5><p>开始一个 “嵌套的” 事务,  它是已经存在事务的一个真正的子事务. 潜套事务开始执行时,  它将取得一个 savepoint. 如果这个嵌套事务失败, 我们将回滚到此 savepoint. 潜套事务是外部事务的一部分, 只有外部事务结束后它才会被提交. </p>
<p>比如我们设计ServiceA.methodA的事务级别为PROPAGATION_REQUIRED，ServiceB.methodB的事务级别为PROPAGATION_NESTED，那么当执行到ServiceB.methodB的时候，ServiceA.methodA所在的事务就会挂起，ServiceB.methodB会起一个新的子事务并设置savepoint，等待ServiceB.methodB的事务完成以后，他才继续执行</p>
<p>因为ServiceB.methodB是外部事务的子事务，那么</p>
<ol>
<li>如果ServiceB.methodB已经提交，那么ServiceA.methodA失败回滚，ServiceB.methodB也将回滚。</li>
<li>如果ServiceB.methodB失败回滚，如果他抛出的异常被ServiceA.methodA的try..catch捕获并处理，ServiceA.methodA事务仍然可能提交；如果他抛出的异常未被ServiceA.methodA捕获处理，ServiceA.methodA事务将回滚。</li>
</ol>
<p>理解Nested的关键是savepoint。</p>
<p><strong>与PROPAGATION_REQUIRES_NEW的区别</strong>：</p>
<ol>
<li>RequiresNew每次都创建新的独立的物理事务，而Nested只有一个物理事务；</li>
<li>Nested嵌套事务回滚或提交不会导致外部事务回滚或提交，但外部事务回滚将导致嵌套事务回滚，而 RequiresNew由于都是全新的事务，所以之间是无关联的；</li>
<li>Nested使用JDBC 3的保存点实现，即如果使用低版本驱动将导致不支持嵌套事务。<br>使用嵌套事务，必须确保具体事务管理器实现的nestedTransactionAllowed属性为true，否则不支持嵌套事务，如DataSourceTransactionManager默认支持，而HibernateTransactionManager默认不支持，需要我们来开启。</li>
</ol>
<p>在 spring 中使用 PROPAGATION_NESTED的前提：</p>
<ol>
<li>我们要设置 transactionManager 的 nestedTransactionAllowed 属性为 true, 注意, 此属性默认为 false!!! </li>
<li>java.sql.Savepoint 必须存在, 即 jdk 版本要 1.4+ </li>
<li>Connection.getMetaData().supportsSavepoints() 必须为 true, 即 jdbc drive 必须支持 JDBC 3.0 </li>
</ol>
<p><img src="http://qnimages.zhuxingsheng.com/transaction/propagation.png" alt="image"></p>
<h3 id="隔离规则"><a href="#隔离规则" class="headerlink" title="隔离规则"></a>隔离规则</h3><p>用来解决并发事务时出现的问题，其使用TransactionDefinition中的静态变量来指定</p>
<ol>
<li>ISOLATION_DEFAULT    使用后端数据库默认的隔离级别</li>
<li>ISOLATION_READ_UNCOMMITTED    最低的隔离级别，允许读取尚未提交的数据变更，可能会导致脏读、幻读或不可重复读</li>
<li>ISOLATION_READ_COMMITTED    允许读取并发事务已经提交的数据，可以阻止脏读，但是幻读或不可重复读仍有可能发生</li>
<li>ISOLATION_REPEATABLE_READ    对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，可以阻止脏读和不可重复读，但幻读仍有可能发生</li>
<li>ISOLATION_SERIALIZABLE    最高的隔离级别，完全服从ACID的隔离级别，确保阻止脏读、不可重复读以及幻读，也是最慢的事务隔离级别，因为它通常是通过完全锁定事务相关的数据库表来实现的</li>
</ol>
<p>可以使用DefaultTransactionDefinition类的setIsolationLevel(TransactionDefinition. ISOLATION_READ_COMMITTED)来指定隔离级别，其中此处表示隔离级别为提交读</p>
<p>也可以使用或setIsolationLevelName(“ISOLATION_READ_COMMITTED”)方式指定，其中参数就是隔离级别静态变量的名字，但不推荐这种方式</p>
<h3 id="事务只读"><a href="#事务只读" class="headerlink" title="事务只读"></a>事务只读</h3><p>将事务标识为只读，只读事务不修改任何数据；</p>
<p>对于JDBC只是简单的将连接设置为只读模式，对于更新将抛出异常；</p>
<p>对于一些其他ORM框架有一些优化作用，如在Hibernate中，Spring事务管理器将执行“session.setFlushMode(FlushMode.MANUAL)”<br>即指定Hibernate会话在只读事务模式下不用尝试检测和同步持久对象的状态的更新。</p>
<p>如果使用设置具体事务管理的validateExistingTransaction属性为true（默认false），将确保整个事务传播链都是只读或都不是只读<br><img src="http://qnimages.zhuxingsheng.com/transaction/readonly.JPG" alt="image"></p>
<p>第二个addressService.save()不能设置成false</p>
<p>对于错误的事务只读设置将抛出IllegalTransactionStateException异常，并伴随“Participating transaction with definition [……] is not marked as read-only……”信息，表示参与的事务只读属性设置错误</p>
<h3 id="事务超时"><a href="#事务超时" class="headerlink" title="事务超时"></a>事务超时</h3><p>设置事务的超时时间，单位为秒，默认为-1表示使用底层事务的超时时间</p>
<p>使用如setTimeout(100)来设置超时时间，如果事务超时将抛出org.springframework.transaction.TransactionTimedOutException异常并将当前事务标记为应该回滚，即超时后事务被自动回滚</p>
<p>可以使用具体事务管理器实现的defaultTimeout属性设置默认的事务超时时间，如DataSourceTransactionManager. setDefaultTimeout(10)</p>
<h3 id="回滚规则"><a href="#回滚规则" class="headerlink" title="回滚规则"></a>回滚规则</h3><p>spring事务管理器会捕捉任何未处理的异常，然后依据规则决定是否回滚抛出异常的事务</p>
<p>默认配置下，Spring只有在抛出的异常为运行时unchecked异常时才回滚该事务，也就是抛出的异常为RuntimeException的子类(Errors也会导致事务回滚)，而抛出checked异常则不会导致事务回滚。可以明确的配置在抛出那些异常时回滚事务，包括checked异常。也可以明确定义那些异常抛出时不回滚事务</p>
<p><strong>如何改变默认规则</strong>：</p>
<ol>
<li>让checked例外也回滚：在整个方法前加上 @Transactional(rollbackFor=Exception.class)</li>
<li>让unchecked例外不回滚： @Transactional(notRollbackFor=RunTimeException.class)</li>
<li>不需要事务管理的(只查询的)方法：@Transactional(propagation=Propagation.NOT_SUPPORTED)</li>
</ol>
<h2 id="事务状态"><a href="#事务状态" class="headerlink" title="事务状态"></a>事务状态</h2><p>上面讲到的调用PlatformTransactionManager接口的getTransaction()的方法得到的是TransactionStatus接口的一个实现，这个接口的内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public interface TransactionStatus&#123;</span><br><span class="line">    boolean isNewTransaction(); // 是否是新的事物</span><br><span class="line">    boolean hasSavepoint(); // 是否有恢复点</span><br><span class="line">    void setRollbackOnly();  // 设置为只回滚</span><br><span class="line">    boolean isRollbackOnly(); // 是否为只回滚</span><br><span class="line">    boolean isCompleted; // 是否已完成</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>可以发现这个接口描述的是一些处理事务提供简单的控制事务执行和查询事务状态的方法，在回滚或提交的时候需要应用对应的事务状态</p>
<h2 id="编程式和声明式事务"><a href="#编程式和声明式事务" class="headerlink" title="编程式和声明式事务"></a>编程式和声明式事务</h2><p>Spring提供了对编程式事务和声明式事务的支持，编程式事务允许用户在代码中精确定义事务的边界</p>
<p>而声明式事务（基于AOP）有助于用户将操作与事务规则进行解耦。 </p>
<p>简单地说，编程式事务侵入到了业务代码里面，但是提供了更加详细的事务管理；而声明式事务由于基于AOP，所以既能起到事务管理的作用，又可以不影响业务代码的具体实现。</p>
<h3 id="编程式"><a href="#编程式" class="headerlink" title="编程式"></a>编程式</h3><p>Spring提供两种方式的编程式事务管理，分别是：使用TransactionTemplate和直接使用PlatformTransactionManager</p>
<h4 id="使用TransactionTemplate"><a href="#使用TransactionTemplate" class="headerlink" title="使用TransactionTemplate"></a>使用TransactionTemplate</h4><p>采用TransactionTemplate和采用其他Spring模板，如JdbcTempalte和HibernateTemplate是一样的方法。它使用回调方法，把应用程序从处理取得和释放资源中解脱出来。如同其他模板，TransactionTemplate是线程安全的。代码片段：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">TransactionTemplate tt = new TransactionTemplate(); // 新建一个TransactionTemplate</span><br><span class="line">Object result = tt.execute(</span><br><span class="line">    new TransactionCallback()&#123;  </span><br><span class="line">        public Object doTransaction(TransactionStatus status)&#123;  </span><br><span class="line">            updateOperation();  </span><br><span class="line">            return resultOfUpdateOperation();  </span><br><span class="line">        &#125;  </span><br><span class="line">&#125;); // 执行execute方法进行事务管理</span><br></pre></td></tr></table></figure></p>
<p>使用TransactionCallback()可以返回一个值。如果使用TransactionCallbackWithoutResult则没有返回值</p>
<h4 id="使用PlatformTransactionManager"><a href="#使用PlatformTransactionManager" class="headerlink" title="使用PlatformTransactionManager"></a>使用PlatformTransactionManager</h4><p>示例代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DataSourceTransactionManager dataSourceTransactionManager = new DataSourceTransactionManager();</span><br><span class="line">//定义一个某个框架平台的TransactionManager，如JDBC、Hibernate</span><br><span class="line">dataSourceTransactionManager.setDataSource(this.getJdbcTemplate().getDataSource()); // 设置数据源</span><br><span class="line">    DefaultTransactionDefinition transDef = new DefaultTransactionDefinition(); // 定义事务属性</span><br><span class="line">    transDef.setPropagationBehavior(DefaultTransactionDefinition.PROPAGATION_REQUIRED); // 设置传播行为属性</span><br><span class="line">    TransactionStatus status = dataSourceTransactionManager.getTransaction(transDef); // 获得事务状态</span><br><span class="line">    try &#123;</span><br><span class="line">        // 数据库操作</span><br><span class="line">        dataSourceTransactionManager.commit(status);// 提交</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        dataSourceTransactionManager.rollback(status);// 回滚</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="声明式"><a href="#声明式" class="headerlink" title="声明式"></a>声明式</h3><p>有几种实现方式，不一一罗列了</p>
<h4 id="使用tx拦截器"><a href="#使用tx拦截器" class="headerlink" title="使用tx拦截器"></a>使用tx拦截器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 定义事务管理器（声明式的事务） --&gt; </span><br><span class="line">    &lt;bean id=&quot;transactionManager&quot;</span><br><span class="line">        class=&quot;org.springframework.orm.hibernate3.HibernateTransactionManager&quot;&gt;</span><br><span class="line">        &lt;property name=&quot;sessionFactory&quot; ref=&quot;sessionFactory&quot; /&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">    &lt;tx:advice id=&quot;txAdvice&quot; transaction-manager=&quot;transactionManager&quot;&gt;</span><br><span class="line">        &lt;tx:attributes&gt;</span><br><span class="line">            &lt;tx:method name=&quot;*&quot; propagation=&quot;REQUIRED&quot; /&gt;</span><br><span class="line">        &lt;/tx:attributes&gt;</span><br><span class="line">    &lt;/tx:advice&gt;</span><br><span class="line"></span><br><span class="line">    &lt;aop:config&gt;</span><br><span class="line">        &lt;aop:pointcut id=&quot;interceptorPointCuts&quot;</span><br><span class="line">            expression=&quot;execution(* com.bluesky.spring.dao.*.*(..))&quot; /&gt;</span><br><span class="line">        &lt;aop:advisor advice-ref=&quot;txAdvice&quot;</span><br><span class="line">            pointcut-ref=&quot;interceptorPointCuts&quot; /&gt;       </span><br><span class="line">    &lt;/aop:config&gt;</span><br></pre></td></tr></table></figure>
<h4 id="全注解"><a href="#全注解" class="headerlink" title="全注解"></a>全注解</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;tx:annotation-driven transaction-manager=&quot;transactionManager&quot; /&gt;</span><br><span class="line">    &lt;bean id=&quot;transactionManager&quot;</span><br><span class="line">          class=&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager &quot;&gt;</span><br><span class="line">        &lt;property name=&quot;dataSource&quot;&gt;</span><br><span class="line">            &lt;ref bean=&quot;basicDataSource&quot; /&gt;</span><br><span class="line">        &lt;/property&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Spring源码片段"><a href="#Spring源码片段" class="headerlink" title="Spring源码片段"></a>Spring源码片段</h2><p>在《BeanPostProcessor学习》中提到了AOP的实现方式，声明式事务实现是基于AOP</p>
<p>首先得解析xml配置，TxNamespaceHandler<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">	public void init() &#123;</span><br><span class="line">		registerBeanDefinitionParser(&quot;advice&quot;, new TxAdviceBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(&quot;annotation-driven&quot;, new AnnotationDrivenBeanDefinitionParser());</span><br><span class="line">		registerBeanDefinitionParser(&quot;jta-transaction-manager&quot;, new JtaTransactionManagerBeanDefinitionParser());</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>主要是TransactionInterceptor类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public Object invoke(final MethodInvocation invocation) throws Throwable &#123;</span><br><span class="line">		// Work out the target class: may be &#123;@code null&#125;.</span><br><span class="line">		// The TransactionAttributeSource should be passed the target class</span><br><span class="line">		// as well as the method, which may be from an interface.</span><br><span class="line">		Class&lt;?&gt; targetClass = (invocation.getThis() != null ? AopUtils.getTargetClass(invocation.getThis()) : null);</span><br><span class="line"></span><br><span class="line">		// Adapt to TransactionAspectSupport&apos;s invokeWithinTransaction...</span><br><span class="line">		//主要逻辑在父类</span><br><span class="line">		return invokeWithinTransaction(invocation.getMethod(), targetClass, new InvocationCallback() &#123;</span><br><span class="line">			@Override</span><br><span class="line">			public Object proceedWithInvocation() throws Throwable &#123;</span><br><span class="line">				return invocation.proceed();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<p>核心逻辑，还得看父类TransactionAspectSupport#invokeWithinTransaction</p>
<p>逻辑主干很清晰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">if (txAttr == null || !(tm instanceof CallbackPreferringPlatformTransactionManager)) &#123;</span><br><span class="line">			// Standard transaction demarcation with getTransaction and commit/rollback calls.</span><br><span class="line">			// 判断创建Transaction</span><br><span class="line">			TransactionInfo txInfo = createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">			Object retVal = null;</span><br><span class="line">			try &#123;</span><br><span class="line">				// This is an around advice: Invoke the next interceptor in the chain.</span><br><span class="line">				// This will normally result in a target object being invoked.</span><br><span class="line">				//执行业务逻辑</span><br><span class="line">				retVal = invocation.proceedWithInvocation();</span><br><span class="line">			&#125;</span><br><span class="line">			catch (Throwable ex) &#123;</span><br><span class="line">				// target invocation exception</span><br><span class="line">				// 出现异常，回滚</span><br><span class="line">				completeTransactionAfterThrowing(txInfo, ex);</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">			finally &#123;</span><br><span class="line">				//清除当前事务状态</span><br><span class="line">				cleanupTransactionInfo(txInfo);</span><br><span class="line">			&#125;</span><br><span class="line">			//提交事务</span><br><span class="line">			commitTransactionAfterReturning(txInfo);</span><br><span class="line">			return retVal;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>
<h3 id="创建事务createTransactionIfNecessary"><a href="#创建事务createTransactionIfNecessary" class="headerlink" title="创建事务createTransactionIfNecessary"></a>创建事务createTransactionIfNecessary</h3><p>主要逻辑在PlatformTransactionManager#getTransaction()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public final TransactionStatus getTransaction(TransactionDefinition definition) throws TransactionException &#123;</span><br><span class="line">		//得到各个不同数据源的事务对象，spring尽然没有把transaction对象抽象出来，很是奇怪</span><br><span class="line">		Object transaction = doGetTransaction();</span><br><span class="line"></span><br><span class="line">		// Cache debug flag to avoid repeated checks.</span><br><span class="line">		boolean debugEnabled = logger.isDebugEnabled();</span><br><span class="line"></span><br><span class="line">		if (definition == null) &#123;</span><br><span class="line">			// Use defaults if no transaction definition given.</span><br><span class="line">			definition = new DefaultTransactionDefinition();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		//此事务是否已经存在</span><br><span class="line">		if (isExistingTransaction(transaction)) &#123;</span><br><span class="line">			// Existing transaction found -&gt; check propagation behavior to find out how to behave.</span><br><span class="line">			return handleExistingTransaction(definition, transaction, debugEnabled);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Check definition settings for new transaction.</span><br><span class="line">		if (definition.getTimeout() &lt; TransactionDefinition.TIMEOUT_DEFAULT) &#123;</span><br><span class="line">			throw new InvalidTimeoutException(&quot;Invalid transaction timeout&quot;, definition.getTimeout());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// No existing transaction found -&gt; check propagation behavior to find out how to proceed.</span><br><span class="line">		if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_MANDATORY) &#123;</span><br><span class="line">			throw new IllegalTransactionStateException(</span><br><span class="line">					&quot;No existing transaction found for transaction marked with propagation &apos;mandatory&apos;&quot;);</span><br><span class="line">		&#125;</span><br><span class="line">		//这三种都是新建事务</span><br><span class="line">		else if (definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRED ||</span><br><span class="line">				definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_REQUIRES_NEW ||</span><br><span class="line">				definition.getPropagationBehavior() == TransactionDefinition.PROPAGATION_NESTED) &#123;</span><br><span class="line">			SuspendedResourcesHolder suspendedResources = suspend(null);</span><br><span class="line">			if (debugEnabled) &#123;</span><br><span class="line">				logger.debug(&quot;Creating new transaction with name [&quot; + definition.getName() + &quot;]: &quot; + definition);</span><br><span class="line">			&#125;</span><br><span class="line">			try &#123;</span><br><span class="line">				boolean newSynchronization = (getTransactionSynchronization() != SYNCHRONIZATION_NEVER);</span><br><span class="line">				DefaultTransactionStatus status = newTransactionStatus(</span><br><span class="line">						definition, transaction, true, newSynchronization, debugEnabled, suspendedResources);</span><br><span class="line">				//开始获取链接，开启事务，绑定资源到当前线程</span><br><span class="line">				doBegin(transaction, definition);</span><br><span class="line">				prepareSynchronization(status, definition);</span><br><span class="line">				return status;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (RuntimeException | Error ex) &#123;</span><br><span class="line">				resume(null, suspendedResources);</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		else &#123;</span><br><span class="line">			// Create &quot;empty&quot; transaction: no actual transaction, but potentially synchronization.</span><br><span class="line">			if (definition.getIsolationLevel() != TransactionDefinition.ISOLATION_DEFAULT &amp;&amp; logger.isWarnEnabled()) &#123;</span><br><span class="line">				logger.warn(&quot;Custom isolation level specified but no actual transaction initiated; &quot; +</span><br><span class="line">						&quot;isolation level will effectively be ignored: &quot; + definition);</span><br><span class="line">			&#125;</span><br><span class="line">			boolean newSynchronization = (getTransactionSynchronization() == SYNCHRONIZATION_ALWAYS);</span><br><span class="line">			return prepareTransactionStatus(definition, null, true, newSynchronization, debugEnabled, null);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="TransactionStatus"><a href="#TransactionStatus" class="headerlink" title="TransactionStatus"></a>TransactionStatus</h4><p>这儿返回的是<strong>TransactionStatus</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public interface TransactionStatus extends SavepointManager, Flushable &#123;</span><br><span class="line"></span><br><span class="line">	boolean isNewTransaction();</span><br><span class="line"></span><br><span class="line">	boolean hasSavepoint();</span><br><span class="line"></span><br><span class="line">	void setRollbackOnly();</span><br><span class="line"></span><br><span class="line">	boolean isRollbackOnly();</span><br><span class="line"></span><br><span class="line">	void flush();</span><br><span class="line"></span><br><span class="line">	boolean isCompleted();</span><br></pre></td></tr></table></figure>
<h4 id="TransactionInfo"><a href="#TransactionInfo" class="headerlink" title="TransactionInfo"></a>TransactionInfo</h4><p>事务信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">protected final class TransactionInfo &#123;</span><br><span class="line"></span><br><span class="line">		private final PlatformTransactionManager transactionManager;</span><br><span class="line"></span><br><span class="line">		private final TransactionAttribute transactionAttribute;</span><br><span class="line"></span><br><span class="line">		private final String joinpointIdentification;</span><br><span class="line"></span><br><span class="line">		private TransactionStatus transactionStatus;</span><br><span class="line"></span><br><span class="line">		private TransactionInfo oldTransactionInfo;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="commitTransactionAfterReturning提交事务"><a href="#commitTransactionAfterReturning提交事务" class="headerlink" title="commitTransactionAfterReturning提交事务"></a>commitTransactionAfterReturning提交事务</h3><p>逻辑到了AbstractPlatformTransactionManager#processRollback<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">private void processRollback(DefaultTransactionStatus status, boolean unexpected) &#123;</span><br><span class="line">		try &#123;</span><br><span class="line">			boolean unexpectedRollback = unexpected;</span><br><span class="line"></span><br><span class="line">			try &#123;</span><br><span class="line">				triggerBeforeCompletion(status);</span><br><span class="line">				//有savepoint，</span><br><span class="line">				if (status.hasSavepoint()) &#123;</span><br><span class="line">					if (status.isDebug()) &#123;</span><br><span class="line">						logger.debug(&quot;Rolling back transaction to savepoint&quot;);</span><br><span class="line">					&#125;</span><br><span class="line">					status.rollbackToHeldSavepoint();</span><br><span class="line">				&#125;</span><br><span class="line">				else if (status.isNewTransaction()) &#123;</span><br><span class="line">					if (status.isDebug()) &#123;</span><br><span class="line">						logger.debug(&quot;Initiating transaction rollback&quot;);</span><br><span class="line">					&#125;</span><br><span class="line">					//回滚事务</span><br><span class="line">					doRollback(status);</span><br><span class="line">				&#125;</span><br><span class="line">				else &#123;</span><br><span class="line">					// Participating in larger transaction</span><br><span class="line">					//在一个事务中，就先设置回滚标识,等父事务一起回滚</span><br><span class="line">					if (status.hasTransaction()) &#123;</span><br><span class="line">						if (status.isLocalRollbackOnly() || isGlobalRollbackOnParticipationFailure()) &#123;</span><br><span class="line">							if (status.isDebug()) &#123;</span><br><span class="line">								logger.debug(&quot;Participating transaction failed - marking existing transaction as rollback-only&quot;);</span><br><span class="line">							&#125;</span><br><span class="line">							doSetRollbackOnly(status);</span><br><span class="line">						&#125;</span><br><span class="line">						else &#123;</span><br><span class="line">							if (status.isDebug()) &#123;</span><br><span class="line">								logger.debug(&quot;Participating transaction failed - letting transaction originator decide on rollback&quot;);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					else &#123;</span><br><span class="line">						logger.debug(&quot;Should roll back transaction but cannot - no transaction available&quot;);</span><br><span class="line">					&#125;</span><br><span class="line">					// Unexpected rollback only matters here if we&apos;re asked to fail early</span><br><span class="line">					if (!isFailEarlyOnGlobalRollbackOnly()) &#123;</span><br><span class="line">						unexpectedRollback = false;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			catch (RuntimeException | Error ex) &#123;</span><br><span class="line">				triggerAfterCompletion(status, TransactionSynchronization.STATUS_UNKNOWN);</span><br><span class="line">				throw ex;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			triggerAfterCompletion(status, TransactionSynchronization.STATUS_ROLLED_BACK);</span><br><span class="line"></span><br><span class="line">			// Raise UnexpectedRollbackException if we had a global rollback-only marker</span><br><span class="line">			if (unexpectedRollback) &#123;</span><br><span class="line">				throw new UnexpectedRollbackException(</span><br><span class="line">						&quot;Transaction rolled back because it has been marked as rollback-only&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		finally &#123;</span><br><span class="line">			cleanupAfterCompletion(status);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="completeTransactionAfterThrowing回滚事务"><a href="#completeTransactionAfterThrowing回滚事务" class="headerlink" title="completeTransactionAfterThrowing回滚事务"></a>completeTransactionAfterThrowing回滚事务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">protected void completeTransactionAfterThrowing(TransactionInfo txInfo, Throwable ex) &#123;</span><br><span class="line">		//有事务才能回滚</span><br><span class="line">		if (txInfo != null &amp;&amp; txInfo.hasTransaction()) &#123;</span><br><span class="line">			if (logger.isTraceEnabled()) &#123;</span><br><span class="line">				logger.trace(&quot;Completing transaction for [&quot; + txInfo.getJoinpointIdentification() +</span><br><span class="line">						&quot;] after exception: &quot; + ex);</span><br><span class="line">			&#125;</span><br><span class="line">			//回滚在 (ex instanceof RuntimeException || ex instanceof Error)</span><br><span class="line">			if (txInfo.transactionAttribute.rollbackOn(ex)) &#123;</span><br><span class="line">				try &#123;</span><br><span class="line">					txInfo.getTransactionManager().rollback(txInfo.getTransactionStatus());</span><br><span class="line">				&#125;</span><br><span class="line">				catch (TransactionSystemException ex2) &#123;</span><br><span class="line">					logger.error(&quot;Application exception overridden by rollback exception&quot;, ex);</span><br><span class="line">					ex2.initApplicationException(ex);</span><br><span class="line">					throw ex2;</span><br><span class="line">				&#125;</span><br><span class="line">				catch (RuntimeException ex2) &#123;</span><br><span class="line">					logger.error(&quot;Application exception overridden by rollback exception&quot;, ex);</span><br><span class="line">					throw ex2;</span><br><span class="line">				&#125;</span><br><span class="line">				catch (Error err) &#123;</span><br><span class="line">					logger.error(&quot;Application exception overridden by rollback error&quot;, ex);</span><br><span class="line">					throw err;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			else &#123;</span><br><span class="line">				// We don&apos;t roll back on this exception.</span><br><span class="line">				// Will still roll back if TransactionStatus.isRollbackOnly() is true.</span><br><span class="line">				try &#123;</span><br><span class="line">					txInfo.getTransactionManager().commit(txInfo.getTransactionStatus());</span><br><span class="line">				&#125;</span><br><span class="line">				catch (TransactionSystemException ex2) &#123;</span><br><span class="line">					logger.error(&quot;Application exception overridden by commit exception&quot;, ex);</span><br><span class="line">					ex2.initApplicationException(ex);</span><br><span class="line">					throw ex2;</span><br><span class="line">				&#125;</span><br><span class="line">				catch (RuntimeException ex2) &#123;</span><br><span class="line">					logger.error(&quot;Application exception overridden by commit exception&quot;, ex);</span><br><span class="line">					throw ex2;</span><br><span class="line">				&#125;</span><br><span class="line">				catch (Error err) &#123;</span><br><span class="line">					logger.error(&quot;Application exception overridden by commit error&quot;, ex);</span><br><span class="line">					throw err;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>一个完整的事务介绍结束了。框架就是封装一切，透明一切，简化一切。本质的流程不会变</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="http://blog.sina.com.cn/s/blog_7ed8b1e90101mgas.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_7ed8b1e90101mgas.html</a></p>
<p><a href="https://my.oschina.net/wanyuxiang000/blog/277568" target="_blank" rel="noopener">https://my.oschina.net/wanyuxiang000/blog/277568</a></p>
<p><a href="http://www.mamicode.com/info-detail-1248286.html" target="_blank" rel="noopener">http://www.mamicode.com/info-detail-1248286.html</a></p>
<p><a href="http://jinnianshilongnian.iteye.com/blog/1496953" target="_blank" rel="noopener">http://jinnianshilongnian.iteye.com/blog/1496953</a></p>
<p><a href="http://www.cnblogs.com/yldIndex/p/spring_Transactional.html" target="_blank" rel="noopener">http://www.cnblogs.com/yldIndex/p/spring_Transactional.html</a></p>
<p><a href="http://jinnianshilongnian.iteye.com/blog/1441271" target="_blank" rel="noopener">http://jinnianshilongnian.iteye.com/blog/1441271</a></p>
<p><a href="http://www.cnblogs.com/chihirotan/p/6739748.html" target="_blank" rel="noopener">http://www.cnblogs.com/chihirotan/p/6739748.html</a></p>

      
    </div>

	<div>
      
        

      
    <strong>深入浅出spring事务：</strong>
    <a href="http://www.zhuxingsheng.com/blog/understanding-spring-transactions-in-depth.html" title="深入浅出spring事务">http://www.zhuxingsheng.com/blog/understanding-spring-transactions-in-depth.html</a>
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="http://qnimages.zhuxingsheng.com/weixin.jpg" alt="朱兴生 wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎大家关注：码农戏码微信公众号</div>
</div>


      
    </div>

    


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spring/" rel="tag"># spring</a>
          
            <a href="/tags/事务/" rel="tag"># 事务</a>
          
        </div>
      

 

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/blog/counter-algorithm.html" rel="next" title="计数器算法">
                <i class="fa fa-chevron-left"></i> 计数器算法
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/blog/microservice-monitoring.html" rel="prev" title="微服务-监控">
                微服务-监控 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<div class="bdsharebuttonbox">
<a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
<a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
<a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a>
<a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a>
<a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a>
<a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
<a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
<a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a>
<a href="#" class="bds_more" data-cmd="more"></a>
</div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{},"image":{"viewList":["tsina","weixin","youdao","evernotecn","tqq","qzone","renren","copy"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","weixin","youdao","evernotecn","tqq","qzone","renren","copy"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/6222636?v=3&s=460"
               alt="朱兴生" />
          <p class="site-author-name" itemprop="name">朱兴生</p>
          <p class="site-description motion-element" itemprop="description">彪悍的人生需要书写</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">26</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhuxingsheng" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#概念"><span class="nav-number">2.</span> <span class="nav-text">概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#事务的特性"><span class="nav-number">2.1.</span> <span class="nav-text">事务的特性</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务并发处理问题"><span class="nav-number">2.2.</span> <span class="nav-text">事务并发处理问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#第一类丢失更新-lost-update"><span class="nav-number">2.2.1.</span> <span class="nav-text">第一类丢失更新(lost update)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#脏读-dirty-read"><span class="nav-number">2.2.2.</span> <span class="nav-text">脏读(dirty read)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#虚读-phantom-read"><span class="nav-number">2.2.3.</span> <span class="nav-text">虚读(phantom read)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#不可重复读-unrepeated-read"><span class="nav-number">2.2.4.</span> <span class="nav-text">不可重复读(unrepeated read)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#第二类丢失更新-second-lost-updates"><span class="nav-number">2.2.5.</span> <span class="nav-text">第二类丢失更新(second lost updates)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#并发问题总结"><span class="nav-number">2.3.</span> <span class="nav-text">并发问题总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#隔离级别"><span class="nav-number">2.4.</span> <span class="nav-text">隔离级别</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#锁"><span class="nav-number">2.4.1.</span> <span class="nav-text">锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#乐观锁-Optimistic-Lock-和悲观锁-Pessimistic-Lock"><span class="nav-number">2.4.1.1.</span> <span class="nav-text">乐观锁(Optimistic Lock)和悲观锁(Pessimistic Lock)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分共享锁（S锁，Shared-Lock）和排他锁（X锁，Exclusive-Lock）"><span class="nav-number">2.4.1.2.</span> <span class="nav-text">分共享锁（S锁，Shared Lock）和排他锁（X锁，Exclusive Lock）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#表级锁（Table-Lock）和行级锁（Row-Lock）"><span class="nav-number">2.4.1.3.</span> <span class="nav-text">表级锁（Table Lock）和行级锁（Row Lock）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三级锁协议"><span class="nav-number">2.4.1.4.</span> <span class="nav-text">三级锁协议</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring事务"><span class="nav-number">3.</span> <span class="nav-text">Spring事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring事务管理器"><span class="nav-number">3.1.</span> <span class="nav-text">Spring事务管理器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JDBC事务"><span class="nav-number">3.1.1.</span> <span class="nav-text">JDBC事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hibernate事务"><span class="nav-number">3.1.2.</span> <span class="nav-text">Hibernate事务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务属性"><span class="nav-number">3.2.</span> <span class="nav-text">事务属性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#传播行为"><span class="nav-number">3.2.1.</span> <span class="nav-text">传播行为</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#传播行为详细"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">传播行为详细</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-REQUIRED"><span class="nav-number">3.2.1.1.1.</span> <span class="nav-text">PROPAGATION_REQUIRED</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-SUPPORTS"><span class="nav-number">3.2.1.1.2.</span> <span class="nav-text">PROPAGATION_SUPPORTS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-MANDATORY"><span class="nav-number">3.2.1.1.3.</span> <span class="nav-text">PROPAGATION_MANDATORY</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-REQUIRES-NEW"><span class="nav-number">3.2.1.1.4.</span> <span class="nav-text">PROPAGATION_REQUIRES_NEW</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-NOT-SUPPORTED"><span class="nav-number">3.2.1.1.5.</span> <span class="nav-text">PROPAGATION_NOT_SUPPORTED</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-NEVER"><span class="nav-number">3.2.1.1.6.</span> <span class="nav-text">PROPAGATION_NEVER</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PROPAGATION-NESTED"><span class="nav-number">3.2.1.1.7.</span> <span class="nav-text">PROPAGATION_NESTED</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#隔离规则"><span class="nav-number">3.2.2.</span> <span class="nav-text">隔离规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务只读"><span class="nav-number">3.2.3.</span> <span class="nav-text">事务只读</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#事务超时"><span class="nav-number">3.2.4.</span> <span class="nav-text">事务超时</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#回滚规则"><span class="nav-number">3.2.5.</span> <span class="nav-text">回滚规则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事务状态"><span class="nav-number">3.3.</span> <span class="nav-text">事务状态</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编程式和声明式事务"><span class="nav-number">3.4.</span> <span class="nav-text">编程式和声明式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#编程式"><span class="nav-number">3.4.1.</span> <span class="nav-text">编程式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用TransactionTemplate"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">使用TransactionTemplate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用PlatformTransactionManager"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">使用PlatformTransactionManager</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#声明式"><span class="nav-number">3.4.2.</span> <span class="nav-text">声明式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用tx拦截器"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">使用tx拦截器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#全注解"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">全注解</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring源码片段"><span class="nav-number">3.5.</span> <span class="nav-text">Spring源码片段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建事务createTransactionIfNecessary"><span class="nav-number">3.5.1.</span> <span class="nav-text">创建事务createTransactionIfNecessary</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TransactionStatus"><span class="nav-number">3.5.1.1.</span> <span class="nav-text">TransactionStatus</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TransactionInfo"><span class="nav-number">3.5.1.2.</span> <span class="nav-text">TransactionInfo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#commitTransactionAfterReturning提交事务"><span class="nav-number">3.5.2.</span> <span class="nav-text">commitTransactionAfterReturning提交事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#completeTransactionAfterThrowing回滚事务"><span class="nav-number">3.5.3.</span> <span class="nav-text">completeTransactionAfterThrowing回滚事务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">4.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">朱兴生</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">共75.7k字</span>
</div>


        

<div class="busuanzi-count">

  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
