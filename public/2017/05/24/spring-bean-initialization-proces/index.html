<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <meta name="baidu-site-verification" content="MXFRoVpC6c" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="spring," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="从这个简单的代码深入，使用AnnotationConfigApplicationContext看一下spring bean的初始化过程123456public static void main(String[] args) &amp;#123;        ApplicationContext context =                new AnnotationConfigApplicatio">
<meta property="og:type" content="article">
<meta property="og:title" content="spring bean初始化过程">
<meta property="og:url" content="https://zhuxingsheng.github.io/2017/05/24/spring-bean-initialization-proces/index.html">
<meta property="og:site_name" content="码农戏码">
<meta property="og:description" content="从这个简单的代码深入，使用AnnotationConfigApplicationContext看一下spring bean的初始化过程123456public static void main(String[] args) &amp;#123;        ApplicationContext context =                new AnnotationConfigApplicatio">
<meta property="og:image" content="http://oirwmbp4e.bkt.clouddn.com/spring/spring-init-debug.png">
<meta property="og:image" content="http://oirwmbp4e.bkt.clouddn.com/spring/AnnotationConfigApplicationContext.jpg">
<meta property="og:updated_time" content="2017-12-17T13:01:31.311Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="spring bean初始化过程">
<meta name="twitter:description" content="从这个简单的代码深入，使用AnnotationConfigApplicationContext看一下spring bean的初始化过程123456public static void main(String[] args) &amp;#123;        ApplicationContext context =                new AnnotationConfigApplicatio">
<meta name="twitter:image" content="http://oirwmbp4e.bkt.clouddn.com/spring/spring-init-debug.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zhuxingsheng.github.io/2017/05/24/spring-bean-initialization-proces/"/>





  <title> spring bean初始化过程 | 码农戏码 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?48897be5dd7a377cc247d8870a476fb8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">码农戏码</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://zhuxingsheng.github.io/2017/05/24/spring-bean-initialization-proces/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="朱兴生">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/6222636?v=3&s=460">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="码农戏码">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="码农戏码" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                spring bean初始化过程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-24T23:54:24+08:00">
                2017-05-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          
	
	  
	  <span class="post-letters-count">
	    &nbsp; | &nbsp;
	    <span>3,466 字</span>
	    &nbsp; | &nbsp;
	    <span>19 min</span>
	  </span>
	  

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>从这个简单的代码深入，使用AnnotationConfigApplicationContext看一下spring bean的初始化过程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">public static void main(String[] args) &#123;</div><div class="line">        ApplicationContext context =</div><div class="line">                new AnnotationConfigApplicationContext(Application.class);</div><div class="line">        MessagePrinter printer = context.getBean(MessagePrinter.class);</div><div class="line">        printer.printMessage();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>设置一个断点，看一下调用过程<br><img src="http://oirwmbp4e.bkt.clouddn.com/spring/spring-init-debug.png" alt="image"></p>
<h1 id="bean创建"><a href="#bean创建" class="headerlink" title="bean创建"></a>bean创建</h1><p>第一个方法进入AnnotationConfigApplicationContext的构造函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">public AnnotationConfigApplicationContext() &#123;</div><div class="line">		this.reader = new AnnotatedBeanDefinitionReader(this);</div><div class="line">		this.scanner = new ClassPathBeanDefinitionScanner(this);</div><div class="line">	&#125;</div><div class="line">public AnnotationConfigApplicationContext(Class&lt;?&gt;... annotatedClasses) &#123;</div><div class="line">   		this();</div><div class="line">   		register(annotatedClasses);</div><div class="line">   		refresh();</div><div class="line">   	&#125;</div></pre></td></tr></table></figure></p>
<p>AnnotationConfigApplicationContext的类结构<br><img src="http://oirwmbp4e.bkt.clouddn.com/spring/AnnotationConfigApplicationContext.jpg" alt="image"><br>在this()的构造函数里面，定义了两个变量，是用来加载BeanDefinition的，具体使用哪个，就看使用的是传入的参数是什么类型就使用哪个构造函数。</p>
<a id="more"></a>
<p>比如我们的例子传入的是class，那就使用的reader<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public void register(Class&lt;?&gt;... annotatedClasses) &#123;</div><div class="line">		Assert.notEmpty(annotatedClasses, &quot;At least one annotated class must be specified&quot;);</div><div class="line">		this.reader.register(annotatedClasses);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>如果传入的是包名，那就使用的是scanner<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public void scan(String... basePackages) &#123;</div><div class="line">		Assert.notEmpty(basePackages, &quot;At least one base package must be specified&quot;);</div><div class="line">		this.scanner.scan(basePackages);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>看下这儿使用的reader.register()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">public void register(Class&lt;?&gt;... annotatedClasses) &#123;</div><div class="line">		for (Class&lt;?&gt; annotatedClass : annotatedClasses) &#123;</div><div class="line">			registerBean(annotatedClass);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">	 * Register a bean from the given bean class, deriving its metadata from</div><div class="line">	 * class-declared annotations.</div><div class="line">	 * @param annotatedClass the class of the bean</div><div class="line">	 * @param name an explicit name for the bean</div><div class="line">	 * @param qualifiers specific qualifier annotations to consider,</div><div class="line">	 * in addition to qualifiers at the bean class level</div><div class="line">*/</div><div class="line">public void registerBean(Class&lt;?&gt; annotatedClass, String name, Class&lt;? extends Annotation&gt;... qualifiers) &#123;</div><div class="line">		AnnotatedGenericBeanDefinition abd = new AnnotatedGenericBeanDefinition(annotatedClass);</div><div class="line">		if (this.conditionEvaluator.shouldSkip(abd.getMetadata())) &#123;</div><div class="line">			return;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		ScopeMetadata scopeMetadata = this.scopeMetadataResolver.resolveScopeMetadata(abd);</div><div class="line">		abd.setScope(scopeMetadata.getScopeName());</div><div class="line">		String beanName = (name != null ? name : this.beanNameGenerator.generateBeanName(abd, this.registry));</div><div class="line">		AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);</div><div class="line">		if (qualifiers != null) &#123;</div><div class="line">			for (Class&lt;? extends Annotation&gt; qualifier : qualifiers) &#123;</div><div class="line">				if (Primary.class == qualifier) &#123;</div><div class="line">					abd.setPrimary(true);</div><div class="line">				&#125;</div><div class="line">				else if (Lazy.class == qualifier) &#123;</div><div class="line">					abd.setLazyInit(true);</div><div class="line">				&#125;</div><div class="line">				else &#123;</div><div class="line">					abd.addQualifier(new AutowireCandidateQualifier(qualifier));</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		BeanDefinitionHolder definitionHolder = new BeanDefinitionHolder(abd, beanName);</div><div class="line">		definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, this.registry);</div><div class="line">		//真正注册bean信息</div><div class="line">		BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, this.registry);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>这个方法的作用，跟注释表达的意思是一样的，从bean class中提取meta data信息。这儿有几个类信息提取类</p>
<p><strong>BeanDefinition</strong><br>A BeanDefinition describes a bean instance, which has property values, constructor argument values, and further information supplied by concrete implementations.</p>
<p><strong>BeanDefinitionHolder</strong><br>Holder for a BeanDefinition with name and aliases.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">//BeanDefinitionReaderUtils</div><div class="line">public static void registerBeanDefinition(</div><div class="line">			BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</div><div class="line">			throws BeanDefinitionStoreException &#123;</div><div class="line"></div><div class="line">		// Register bean definition under primary name.</div><div class="line">		String beanName = definitionHolder.getBeanName();</div><div class="line">		//这儿就到了DefaultListableBeanFactory里面</div><div class="line">		registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</div><div class="line"></div><div class="line">		// Register aliases for bean name, if any.</div><div class="line">		String[] aliases = definitionHolder.getAliases();</div><div class="line">		if (aliases != null) &#123;</div><div class="line">			for (String alias : aliases) &#123;</div><div class="line">				registry.registerAlias(beanName, alias);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p><em>DefaultListableBeanFactory</em> 它包含了基本Spirng IoC容器所具有的重要功能，开发时不论是使用BeanFactory系列还是ApplicationContext系列来创建容器基本都会使用到DefaultListableBeanFactory类，<br>可以这么说，在spring中实际上把它当成默认的IoC容器来使用</p>
<p>所有bean的信息都保存在DefaultListableBeanFactory中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/** Map of bean definition objects, keyed by bean name */</div><div class="line">private final Map&lt;String, BeanDefinition&gt; beanDefinitionMap = new ConcurrentHashMap&lt;String, BeanDefinition&gt;(256);</div><div class="line">/** List of bean definition names, in registration order */</div><div class="line">private volatile List&lt;String&gt; beanDefinitionNames = new ArrayList&lt;String&gt;(256);</div></pre></td></tr></table></figure></p>
<p>上面的registerBean只才注册了一个主类，那别的bean是什么时候注册的呢？</p>
<p>第二步进入到AbstractApplicationContext的refresh()，一大串方法调用，看得头晕了。挑选重要的方法再单独注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">public void refresh() throws BeansException, IllegalStateException &#123;</div><div class="line">		synchronized (this.startupShutdownMonitor) &#123;</div><div class="line">			// Prepare this context for refreshing.</div><div class="line">			prepareRefresh();</div><div class="line"></div><div class="line">			// Tell the subclass to refresh the internal bean factory.</div><div class="line">			ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();</div><div class="line"></div><div class="line">			// Prepare the bean factory for use in this context.</div><div class="line">			prepareBeanFactory(beanFactory);</div><div class="line"></div><div class="line">			try &#123;</div><div class="line">				// Allows post-processing of the bean factory in context subclasses.</div><div class="line">				postProcessBeanFactory(beanFactory);</div><div class="line"></div><div class="line">				// Invoke factory processors registered as beans in the context.</div><div class="line">				invokeBeanFactoryPostProcessors(beanFactory);</div><div class="line"></div><div class="line">				// Register bean processors that intercept bean creation.</div><div class="line">				registerBeanPostProcessors(beanFactory);</div><div class="line"></div><div class="line">				// Initialize message source for this context.</div><div class="line">				initMessageSource();</div><div class="line"></div><div class="line">				// Initialize event multicaster for this context.</div><div class="line">				initApplicationEventMulticaster();</div><div class="line"></div><div class="line">				// Initialize other special beans in specific context subclasses.</div><div class="line">				onRefresh();</div><div class="line"></div><div class="line">				// Check for listener beans and register them.</div><div class="line">				registerListeners();</div><div class="line"></div><div class="line">				// Instantiate all remaining (non-lazy-init) singletons.</div><div class="line">				finishBeanFactoryInitialization(beanFactory);</div><div class="line"></div><div class="line">				// Last step: publish corresponding event.</div><div class="line">				finishRefresh();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			catch (BeansException ex) &#123;</div><div class="line">				if (logger.isWarnEnabled()) &#123;</div><div class="line">					logger.warn(&quot;Exception encountered during context initialization - &quot; +</div><div class="line">							&quot;cancelling refresh attempt: &quot; + ex);</div><div class="line">				&#125;</div><div class="line"></div><div class="line">				// Destroy already created singletons to avoid dangling resources.</div><div class="line">				destroyBeans();</div><div class="line"></div><div class="line">				// Reset &apos;active&apos; flag.</div><div class="line">				cancelRefresh(ex);</div><div class="line"></div><div class="line">				// Propagate exception to caller.</div><div class="line">				throw ex;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			finally &#123;</div><div class="line">				// Reset common introspection caches in Spring&apos;s core, since we</div><div class="line">				// might not ever need metadata for singleton beans anymore...</div><div class="line">				resetCommonCaches();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">//这个就是做准备工作，很简单的变量初始化</div><div class="line">protected void prepareRefresh() &#123;</div><div class="line">		this.startupDate = System.currentTimeMillis();</div><div class="line">		this.closed.set(false);</div><div class="line">		this.active.set(true);</div><div class="line"></div><div class="line">		if (logger.isInfoEnabled()) &#123;</div><div class="line">			logger.info(&quot;Refreshing &quot; + this);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// Initialize any placeholder property sources in the context environment</div><div class="line">		initPropertySources();</div><div class="line"></div><div class="line">		// Validate that all properties marked as required are resolvable</div><div class="line">		// see ConfigurablePropertyResolver#setRequiredProperties</div><div class="line">		getEnvironment().validateRequiredProperties();</div><div class="line"></div><div class="line">		// Allow for the collection of early ApplicationEvents,</div><div class="line">		// to be published once the multicaster is available...</div><div class="line">		this.earlyApplicationEvents = new LinkedHashSet&lt;ApplicationEvent&gt;();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// Invoke factory processors registered as beans in the context.</div><div class="line">  invokeBeanFactoryPostProcessors(beanFactory);</div><div class="line">  </div><div class="line">  protected void invokeBeanFactoryPostProcessors(ConfigurableListableBeanFactory beanFactory) &#123;</div><div class="line">  		PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());</div><div class="line">  </div><div class="line">  		// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</div><div class="line">  		// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</div><div class="line">  		if (beanFactory.getTempClassLoader() == null &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</div><div class="line">  			beanFactory.addBeanPostProcessor(new LoadTimeWeaverAwareProcessor(beanFactory));</div><div class="line">  			beanFactory.setTempClassLoader(new ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));</div><div class="line">  		&#125;</div><div class="line">  	&#125;</div></pre></td></tr></table></figure>
<p>看第三个方法是finishBeanFactoryInitialization()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">	 * Finish the initialization of this context&apos;s bean factory,</div><div class="line">	 * initializing all remaining singleton beans.</div><div class="line">	 */</div><div class="line">	protected void finishBeanFactoryInitialization(ConfigurableListableBeanFactory beanFactory)&#123;</div><div class="line">	.</div><div class="line">	.</div><div class="line">	.</div><div class="line">	// Instantiate all remaining (non-lazy-init) singletons.</div><div class="line">    beanFactory.preInstantiateSingletons();</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法，就是初始化非延迟加载的单例bean。</p>
<p>下一步就到了DefaultListableBeanFactory.preInstantiateSingletons()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">public void preInstantiateSingletons() throws BeansException &#123;</div><div class="line">		if (this.logger.isDebugEnabled()) &#123;</div><div class="line">			this.logger.debug(&quot;Pre-instantiating singletons in &quot; + this);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// Iterate over a copy to allow for init methods which in turn register new bean definitions.</div><div class="line">		// While this may not be part of the regular factory bootstrap, it does otherwise work fine.</div><div class="line">		List&lt;String&gt; beanNames = new ArrayList&lt;&gt;(this.beanDefinitionNames);</div><div class="line"></div><div class="line">		// Trigger initialization of all non-lazy singleton beans...</div><div class="line">		for (String beanName : beanNames) &#123;</div><div class="line">			RootBeanDefinition bd = getMergedLocalBeanDefinition(beanName);</div><div class="line">			//非抽象，非延迟加载的单例类</div><div class="line">			if (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</div><div class="line">				if (isFactoryBean(beanName)) &#123;</div><div class="line">					final FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) getBean(FACTORY_BEAN_PREFIX + beanName);</div><div class="line">					boolean isEagerInit;</div><div class="line">					if (System.getSecurityManager() != null &amp;&amp; factory instanceof SmartFactoryBean) &#123;</div><div class="line">						isEagerInit = AccessController.doPrivileged(new PrivilegedAction&lt;Boolean&gt;() &#123;</div><div class="line">							@Override</div><div class="line">							public Boolean run() &#123;</div><div class="line">								return ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit();</div><div class="line">							&#125;</div><div class="line">						&#125;, getAccessControlContext());</div><div class="line">					&#125;</div><div class="line">					else &#123;</div><div class="line">						isEagerInit = (factory instanceof SmartFactoryBean &amp;&amp;</div><div class="line">								((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</div><div class="line">					&#125;</div><div class="line">					if (isEagerInit) &#123;</div><div class="line">						getBean(beanName);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				else &#123;</div><div class="line">					//get方法中进行创建</div><div class="line">					getBean(beanName);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div></pre></td></tr></table></figure></p>
<p>getBean的具体执行，到了AbstractBeanFactory.doGetBean方法中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">protected &lt;T&gt; T doGetBean(</div><div class="line">			final String name, final Class&lt;T&gt; requiredType, final Object[] args, boolean typeCheckOnly)</div><div class="line">			throws BeansException &#123;</div><div class="line">		</div><div class="line">        //从map中取beanObject</div><div class="line">        Object sharedInstance = getSingleton(beanName);</div><div class="line">        .</div><div class="line">        .</div><div class="line">        .</div><div class="line">        // Create bean instance.</div><div class="line">        				if (mbd.isSingleton()) &#123;</div><div class="line">        					//单例类开始创建了</div><div class="line">        					sharedInstance = getSingleton(beanName, new ObjectFactory&lt;Object&gt;() &#123;</div><div class="line">        						@Override</div><div class="line">        						public Object getObject() throws BeansException &#123;</div><div class="line">        							try &#123;</div><div class="line">        								return createBean(beanName, mbd, args);</div><div class="line">        							&#125;</div><div class="line">        							catch (BeansException ex) &#123;</div><div class="line">        								// Explicitly remove instance from singleton cache: It might have been put there</div><div class="line">        								// eagerly by the creation process, to allow for circular reference resolution.</div><div class="line">        								// Also remove any beans that received a temporary reference to the bean.</div><div class="line">        								destroySingleton(beanName);</div><div class="line">        								throw ex;</div><div class="line">        							&#125;</div><div class="line">        						&#125;</div><div class="line">        					&#125;);</div><div class="line">        					bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</div><div class="line">        				&#125;</div><div class="line"></div><div class="line">        //DefaultSingletonBeanRegistry的getSingleton()</div><div class="line">       public Object getSingleton(String beanName, ObjectFactory&lt;?&gt; singletonFactory) &#123;</div><div class="line">       		Assert.notNull(beanName, &quot;&apos;beanName&apos; must not be null&quot;);</div><div class="line">       		synchronized (this.singletonObjects) &#123;</div><div class="line">       			Object singletonObject = this.singletonObjects.get(beanName);</div><div class="line">       			if (singletonObject == null) &#123;</div><div class="line">       				if (this.singletonsCurrentlyInDestruction) &#123;</div><div class="line">       					throw new BeanCreationNotAllowedException(beanName,</div><div class="line">       							&quot;Singleton bean creation not allowed while singletons of this factory are in destruction &quot; +</div><div class="line">       							&quot;(Do not request a bean from a BeanFactory in a destroy method implementation!)&quot;);</div><div class="line">       				&#125;</div><div class="line">       				if (logger.isDebugEnabled()) &#123;</div><div class="line">       					logger.debug(&quot;Creating shared instance of singleton bean &apos;&quot; + beanName + &quot;&apos;&quot;);</div><div class="line">       				&#125;</div><div class="line">       				beforeSingletonCreation(beanName);</div><div class="line">       				boolean newSingleton = false;</div><div class="line">       				boolean recordSuppressedExceptions = (this.suppressedExceptions == null);</div><div class="line">       				if (recordSuppressedExceptions) &#123;</div><div class="line">       					this.suppressedExceptions = new LinkedHashSet&lt;&gt;();</div><div class="line">       				&#125;</div><div class="line">       				try &#123;</div><div class="line">       					//这儿创建bean</div><div class="line">       					singletonObject = singletonFactory.getObject();</div><div class="line">       					newSingleton = true;</div><div class="line">       				&#125;</div><div class="line">       				catch (IllegalStateException ex) &#123;</div><div class="line">       					// Has the singleton object implicitly appeared in the meantime -&gt;</div><div class="line">       					// if yes, proceed with it since the exception indicates that state.</div><div class="line">       					singletonObject = this.singletonObjects.get(beanName);</div><div class="line">       					if (singletonObject == null) &#123;</div><div class="line">       						throw ex;</div><div class="line">       					&#125;</div><div class="line">       				&#125;</div><div class="line">       				catch (BeanCreationException ex) &#123;</div><div class="line">       					if (recordSuppressedExceptions) &#123;</div><div class="line">       						for (Exception suppressedException : this.suppressedExceptions) &#123;</div><div class="line">       							ex.addRelatedCause(suppressedException);</div><div class="line">       						&#125;</div><div class="line">       					&#125;</div><div class="line">       					throw ex;</div><div class="line">       				&#125;</div><div class="line">       				finally &#123;</div><div class="line">       					if (recordSuppressedExceptions) &#123;</div><div class="line">       						this.suppressedExceptions = null;</div><div class="line">       					&#125;</div><div class="line">       					afterSingletonCreation(beanName);</div><div class="line">       				&#125;</div><div class="line">       				//第一次创建成功后，放到map singletonObjects中</div><div class="line">       				if (newSingleton) &#123;</div><div class="line">       					addSingleton(beanName, singletonObject);</div><div class="line">       				&#125;</div><div class="line">       			&#125;</div><div class="line">       			return (singletonObject != NULL_OBJECT ? singletonObject : null);</div><div class="line">       		&#125;</div><div class="line">       	&#125;</div></pre></td></tr></table></figure></p>
<p>再到AbstractAutowireCapableBeanFactory.createBeanInstance()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">protected BeanWrapper createBeanInstance(String beanName, RootBeanDefinition mbd, Object[] args) &#123;</div><div class="line">		// Make sure bean class is actually resolved at this point.</div><div class="line">		Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</div><div class="line"></div><div class="line">		if (beanClass != null &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;</div><div class="line">			throw new BeanCreationException(mbd.getResourceDescription(), beanName,</div><div class="line">					&quot;Bean class isn&apos;t public, and non-public access not allowed: &quot; + beanClass.getName());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();</div><div class="line">		if (instanceSupplier != null) &#123;</div><div class="line">			return obtainFromSupplier(instanceSupplier, beanName);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (mbd.getFactoryMethodName() != null)  &#123;</div><div class="line">			return instantiateUsingFactoryMethod(beanName, mbd, args);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// Shortcut when re-creating the same bean...</div><div class="line">		boolean resolved = false;</div><div class="line">		boolean autowireNecessary = false;</div><div class="line">		if (args == null) &#123;</div><div class="line">			synchronized (mbd.constructorArgumentLock) &#123;</div><div class="line">				if (mbd.resolvedConstructorOrFactoryMethod != null) &#123;</div><div class="line">					resolved = true;</div><div class="line">					autowireNecessary = mbd.constructorArgumentsResolved;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		if (resolved) &#123;</div><div class="line">			if (autowireNecessary) &#123;</div><div class="line">				return autowireConstructor(beanName, mbd, null, null);</div><div class="line">			&#125;</div><div class="line">			else &#123;</div><div class="line">				return instantiateBean(beanName, mbd);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// Need to determine the constructor...</div><div class="line">		//有没有构造函数，有构造函数，使用构造函数创建</div><div class="line">		Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</div><div class="line">		if (ctors != null ||</div><div class="line">				mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</div><div class="line">				mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</div><div class="line">			return autowireConstructor(beanName, mbd, ctors, args);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// No special handling: simply use no-arg constructor.</div><div class="line">		//没有构造函数，直接create</div><div class="line">		return instantiateBean(beanName, mbd);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	protected BeanWrapper instantiateBean(final String beanName, final RootBeanDefinition mbd) &#123;</div><div class="line">    		try &#123;</div><div class="line">    			Object beanInstance;</div><div class="line">    			final BeanFactory parent = this;</div><div class="line">    			if (System.getSecurityManager() != null) &#123;</div><div class="line">    				beanInstance = AccessController.doPrivileged(new PrivilegedAction&lt;Object&gt;() &#123;</div><div class="line">    					@Override</div><div class="line">    					public Object run() &#123;</div><div class="line">    						return getInstantiationStrategy().instantiate(mbd, beanName, parent);</div><div class="line">    					&#125;</div><div class="line">    				&#125;, getAccessControlContext());</div><div class="line">    			&#125;</div><div class="line">    			else &#123;</div><div class="line">    				//初始化bean，选择不同的策略，一种使用简单的newInstance,还有一种需要cglib创建</div><div class="line">    				beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</div><div class="line">    			&#125;</div><div class="line">    			BeanWrapper bw = new BeanWrapperImpl(beanInstance);</div><div class="line">    			initBeanWrapper(bw);</div><div class="line">    			return bw;</div><div class="line">    		&#125;</div><div class="line">    		catch (Throwable ex) &#123;</div><div class="line">    			throw new BeanCreationException(</div><div class="line">    					mbd.getResourceDescription(), beanName, &quot;Instantiation of bean failed&quot;, ex);</div><div class="line">    		&#125;</div><div class="line">    	&#125;</div></pre></td></tr></table></figure></p>
<p>没有使用cglib方式，直接使用SimpleInstantiationStrategy.instantiate()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">public Object instantiate(RootBeanDefinition bd, String beanName, BeanFactory owner) &#123;</div><div class="line">		// Don&apos;t override the class with CGLIB if no overrides.</div><div class="line">		if (bd.getMethodOverrides().isEmpty()) &#123;</div><div class="line">			Constructor&lt;?&gt; constructorToUse;</div><div class="line">			synchronized (bd.constructorArgumentLock) &#123;</div><div class="line">				constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;</div><div class="line">				if (constructorToUse == null) &#123;</div><div class="line">					final Class&lt;?&gt; clazz = bd.getBeanClass();</div><div class="line">					if (clazz.isInterface()) &#123;</div><div class="line">						throw new BeanInstantiationException(clazz, &quot;Specified class is an interface&quot;);</div><div class="line">					&#125;</div><div class="line">					try &#123;</div><div class="line">						if (System.getSecurityManager() != null) &#123;</div><div class="line">							constructorToUse = AccessController.doPrivileged(new PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;() &#123;</div><div class="line">								@Override</div><div class="line">								public Constructor&lt;?&gt; run() throws Exception &#123;</div><div class="line">									return clazz.getDeclaredConstructor((Class[]) null);</div><div class="line">								&#125;</div><div class="line">							&#125;);</div><div class="line">						&#125;</div><div class="line">						else &#123;</div><div class="line">						    //取到构造函数</div><div class="line">							constructorToUse =	clazz.getDeclaredConstructor((Class[]) null);</div><div class="line">						&#125;</div><div class="line">						bd.resolvedConstructorOrFactoryMethod = constructorToUse;</div><div class="line">					&#125;</div><div class="line">					catch (Throwable ex) &#123;</div><div class="line">						throw new BeanInstantiationException(clazz, &quot;No default constructor found&quot;, ex);</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			//根据构造函数创建bean</div><div class="line">			return BeanUtils.instantiateClass(constructorToUse);</div><div class="line">		&#125;</div><div class="line">		else &#123;</div><div class="line">			// Must generate CGLIB subclass.</div><div class="line">			return instantiateWithMethodInjection(bd, beanName, owner);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	//BeanUtils.instantiateClass(constructorToUse)</div><div class="line">	public static &lt;T&gt; T instantiateClass(Constructor&lt;T&gt; ctor, Object... args) throws BeanInstantiationException &#123;</div><div class="line">    		Assert.notNull(ctor, &quot;Constructor must not be null&quot;);</div><div class="line">    		try &#123;</div><div class="line">    			ReflectionUtils.makeAccessible(ctor);</div><div class="line">    			//通过构造函数，最原始的创建方式</div><div class="line">    			return ctor.newInstance(args);</div><div class="line">    		&#125;</div><div class="line">    		catch (InstantiationException ex) &#123;</div><div class="line">    			throw new BeanInstantiationException(ctor, &quot;Is it an abstract class?&quot;, ex);</div><div class="line">    		&#125;</div><div class="line">    		catch (IllegalAccessException ex) &#123;</div><div class="line">    			throw new BeanInstantiationException(ctor, &quot;Is the constructor accessible?&quot;, ex);</div><div class="line">    		&#125;</div><div class="line">    		catch (IllegalArgumentException ex) &#123;</div><div class="line">    			throw new BeanInstantiationException(ctor, &quot;Illegal arguments for constructor&quot;, ex);</div><div class="line">    		&#125;</div><div class="line">    		catch (InvocationTargetException ex) &#123;</div><div class="line">    			throw new BeanInstantiationException(ctor, &quot;Constructor threw exception&quot;, ex.getTargetException());</div><div class="line">    		&#125;</div><div class="line">    	&#125;</div></pre></td></tr></table></figure></p>
<p>这个创建过程，它的原理很简单，无非就是把一个Bean创建后，放到一个以beanname作为key的map里面。</p>
<p>单例类是只创建一次，放到map中；而原型类需要每次都去创建一个新的</p>
<p>但现实比理论复杂得多，有很多的附加增强，导致了代码很复杂。</p>
<p>需要先把握核心点，抽丝剥茧</p>
<h1 id="属性注入"><a href="#属性注入" class="headerlink" title="属性注入"></a>属性注入</h1><p>对调用链进行分析，大体的流程是</p>
<ol>
<li>创建bean</li>
<li>找到@Autowired的对象</li>
<li>创建注入对象，并赋值</li>
</ol>
<p>AbstractAutowireCapableBeanFactory<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">protected Object doCreateBean(final String beanName, final RootBeanDefinition mbd, final Object[] args)</div><div class="line">			throws BeanCreationException &#123;</div><div class="line"></div><div class="line">		// Instantiate the bean.</div><div class="line">		BeanWrapper instanceWrapper = null;</div><div class="line">		if (mbd.isSingleton()) &#123;</div><div class="line">			instanceWrapper = this.factoryBeanInstanceCache.remove(beanName);</div><div class="line">		&#125;</div><div class="line">		//创建bean对象</div><div class="line">		if (instanceWrapper == null) &#123;</div><div class="line">			instanceWrapper = createBeanInstance(beanName, mbd, args);</div><div class="line">		&#125;</div><div class="line">		final Object bean = (instanceWrapper != null ? instanceWrapper.getWrappedInstance() : null);</div><div class="line">		Class&lt;?&gt; beanType = (instanceWrapper != null ? instanceWrapper.getWrappedClass() : null);</div><div class="line">		mbd.resolvedTargetType = beanType;</div><div class="line"></div><div class="line">		// Allow post-processors to modify the merged bean definition.</div><div class="line">		synchronized (mbd.postProcessingLock) &#123;</div><div class="line">			if (!mbd.postProcessed) &#123;</div><div class="line">				try &#123;</div><div class="line">				    //这儿进一步丰富BeanDefinition,提取bean的属性，方法信息进行</div><div class="line">					applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</div><div class="line">				&#125;</div><div class="line">				catch (Throwable ex) &#123;</div><div class="line">					throw new BeanCreationException(mbd.getResourceDescription(), beanName,</div><div class="line">							&quot;Post-processing of merged bean definition failed&quot;, ex);</div><div class="line">				&#125;</div><div class="line">				mbd.postProcessed = true;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		.</div><div class="line">		.</div><div class="line">		.</div><div class="line">		// Initialize the bean instance.</div><div class="line">        Object exposedObject = bean;</div><div class="line">        try &#123;</div><div class="line">            //属性赋值</div><div class="line">            populateBean(beanName, mbd, instanceWrapper);</div><div class="line">            if (exposedObject != null) &#123;</div><div class="line">                exposedObject = initializeBean(beanName, exposedObject, mbd);</div><div class="line">            &#125;</div><div class="line">        &#125;</div></pre></td></tr></table></figure></p>
<p>到了AutowiredAnnotationBeanPostProcessor<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class&lt;?&gt; beanType, String beanName) &#123;</div><div class="line">		if (beanType != null) &#123;</div><div class="line">			//查找@Autowired注解的元元素</div><div class="line">			InjectionMetadata metadata = findAutowiringMetadata(beanName, beanType, null);</div><div class="line">			//把这个metadata注册进beanDefinition</div><div class="line">			metadata.checkConfigMembers(beanDefinition);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>看看查找@Autowired注解元素<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">private AnnotationAttributes findAutowiredAnnotation(AccessibleObject ao) &#123;</div><div class="line">		if (ao.getAnnotations().length &gt; 0) &#123;</div><div class="line">			for (Class&lt;? extends Annotation&gt; type : this.autowiredAnnotationTypes) &#123;</div><div class="line">				AnnotationAttributes attributes = AnnotatedElementUtils.getMergedAnnotationAttributes(ao, type);</div><div class="line">				if (attributes != null) &#123;</div><div class="line">					return attributes;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		return null;</div><div class="line">	&#125;</div><div class="line">private final Set&lt;Class&lt;? extends Annotation&gt;&gt; autowiredAnnotationTypes = new LinkedHashSet&lt;&gt;();</div><div class="line">public AutowiredAnnotationBeanPostProcessor() &#123;</div><div class="line">		this.autowiredAnnotationTypes.add(Autowired.class);</div><div class="line">		this.autowiredAnnotationTypes.add(Value.class);</div><div class="line">		try &#123;</div><div class="line">			this.autowiredAnnotationTypes.add((Class&lt;? extends Annotation&gt;)</div><div class="line">					ClassUtils.forName(&quot;javax.inject.Inject&quot;, AutowiredAnnotationBeanPostProcessor.class.getClassLoader()));</div><div class="line">			logger.info(&quot;JSR-330 &apos;javax.inject.Inject&apos; annotation found and supported for autowiring&quot;);</div><div class="line">		&#125;</div><div class="line">		catch (ClassNotFoundException ex) &#123;</div><div class="line">			// JSR-330 API not available - simply skip.</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>对@Autowired元素的赋值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">protected void populateBean(String beanName, RootBeanDefinition mbd, BeanWrapper bw) &#123;</div><div class="line">		PropertyValues pvs = mbd.getPropertyValues();</div><div class="line"></div><div class="line">		if (bw == null) &#123;</div><div class="line">			if (!pvs.isEmpty()) &#123;</div><div class="line">				throw new BeanCreationException(</div><div class="line">						mbd.getResourceDescription(), beanName, &quot;Cannot apply property values to null instance&quot;);</div><div class="line">			&#125;</div><div class="line">			else &#123;</div><div class="line">				// Skip property population phase for null instance.</div><div class="line">				return;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		// Give any InstantiationAwareBeanPostProcessors the opportunity to modify the</div><div class="line">		// state of the bean before properties are set. This can be used, for example,</div><div class="line">		// to support styles of field injection.</div><div class="line">		boolean continueWithPropertyPopulation = true;</div><div class="line"></div><div class="line">		if (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</div><div class="line">			for (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</div><div class="line">				if (bp instanceof InstantiationAwareBeanPostProcessor) &#123;</div><div class="line">					InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</div><div class="line">					if (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</div><div class="line">						continueWithPropertyPopulation = false;</div><div class="line">						break;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (!continueWithPropertyPopulation) &#123;</div><div class="line">			return;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME ||</div><div class="line">				mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</div><div class="line">			MutablePropertyValues newPvs = new MutablePropertyValues(pvs);</div><div class="line"></div><div class="line">			// Add property values based on autowire by name if applicable.</div><div class="line">			if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123;</div><div class="line">				autowireByName(beanName, mbd, bw, newPvs);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			// Add property values based on autowire by type if applicable.</div><div class="line">			if (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</div><div class="line">				autowireByType(beanName, mbd, bw, newPvs);</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			pvs = newPvs;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		boolean hasInstAwareBpps = hasInstantiationAwareBeanPostProcessors();</div><div class="line">		boolean needsDepCheck = (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE);</div><div class="line"></div><div class="line">		if (hasInstAwareBpps || needsDepCheck) &#123;</div><div class="line">			PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</div><div class="line">			if (hasInstAwareBpps) &#123;</div><div class="line">				for (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</div><div class="line">					if (bp instanceof InstantiationAwareBeanPostProcessor) &#123;</div><div class="line">						InstantiationAwareBeanPostProcessor ibp = (InstantiationAwareBeanPostProcessor) bp;</div><div class="line">						//赋值行为</div><div class="line">						pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</div><div class="line">						if (pvs == null) &#123;</div><div class="line">							return;</div><div class="line">						&#125;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">			if (needsDepCheck) &#123;</div><div class="line">				checkDependencies(beanName, mbd, filteredPds, pvs);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		applyPropertyValues(beanName, mbd, bw, pvs);</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>到AutowiredAnnotationBeanPostProcessor里，这个BeanPostProcessor会有很多，这个以后再说<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">public PropertyValues postProcessPropertyValues(</div><div class="line">			PropertyValues pvs, PropertyDescriptor[] pds, Object bean, String beanName) throws BeanCreationException &#123;</div><div class="line"></div><div class="line">		//找到@Autowired的元元素</div><div class="line">		InjectionMetadata metadata = findAutowiringMetadata(beanName, bean.getClass(), pvs);</div><div class="line">		try &#123;</div><div class="line">			metadata.inject(bean, beanName, pvs);</div><div class="line">		&#125;</div><div class="line">		catch (BeanCreationException ex) &#123;</div><div class="line">			throw ex;</div><div class="line">		&#125;</div><div class="line">		catch (Throwable ex) &#123;</div><div class="line">			throw new BeanCreationException(beanName, &quot;Injection of autowired dependencies failed&quot;, ex);</div><div class="line">		&#125;</div><div class="line">		return pvs;</div><div class="line">	&#125;</div><div class="line">// #InjectionMetadata</div><div class="line">public void inject(Object target, String beanName, PropertyValues pvs) throws Throwable &#123;</div><div class="line">		Collection&lt;InjectedElement&gt; elementsToIterate =</div><div class="line">				(this.checkedElements != null ? this.checkedElements : this.injectedElements);</div><div class="line">		if (!elementsToIterate.isEmpty()) &#123;</div><div class="line">			boolean debug = logger.isDebugEnabled();</div><div class="line">			//循环每个@Autowired的元素</div><div class="line">			for (InjectedElement element : elementsToIterate) &#123;</div><div class="line">				if (debug) &#123;</div><div class="line">					logger.debug(&quot;Processing injected element of bean &apos;&quot; + beanName + &quot;&apos;: &quot; + element);</div><div class="line">				&#125;</div><div class="line">				element.inject(target, beanName, pvs);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<p>到具体inject方法</p>
<p>AutowiredAnnotationBeanPostProcessor#AutowiredMethodElement#inject()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">protected void inject(Object bean, String beanName, PropertyValues pvs) throws Throwable &#123;</div><div class="line">			if (checkPropertySkipping(pvs)) &#123;</div><div class="line">				return;</div><div class="line">			&#125;</div><div class="line">			//具体的@Autowired方法</div><div class="line">			Method method = (Method) this.member;</div><div class="line">			Object[] arguments;</div><div class="line">			if (this.cached) &#123;</div><div class="line">				// Shortcut for avoiding synchronization...</div><div class="line">				arguments = resolveCachedArguments(beanName);</div><div class="line">			&#125;</div><div class="line">			else &#123;</div><div class="line">				Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</div><div class="line">				arguments = new Object[paramTypes.length];</div><div class="line">				DependencyDescriptor[] descriptors = new DependencyDescriptor[paramTypes.length];</div><div class="line">				Set&lt;String&gt; autowiredBeans = new LinkedHashSet&lt;&gt;(paramTypes.length);</div><div class="line">				TypeConverter typeConverter = beanFactory.getTypeConverter();</div><div class="line">				for (int i = 0; i &lt; arguments.length; i++) &#123;</div><div class="line">					MethodParameter methodParam = new MethodParameter(method, i);</div><div class="line">					DependencyDescriptor currDesc = new DependencyDescriptor(methodParam, this.required);</div><div class="line">					currDesc.setContainingClass(bean.getClass());</div><div class="line">					descriptors[i] = currDesc;</div><div class="line">					try &#123;</div><div class="line">						//获取到被注入的bean</div><div class="line">						Object arg = beanFactory.resolveDependency(currDesc, beanName, autowiredBeans, typeConverter);</div><div class="line">						if (arg == null &amp;&amp; !this.required) &#123;</div><div class="line">							arguments = null;</div><div class="line">							break;</div><div class="line">						&#125;</div><div class="line">						arguments[i] = arg;</div><div class="line">					&#125;</div><div class="line">					catch (BeansException ex) &#123;</div><div class="line">						throw new UnsatisfiedDependencyException(null, beanName, new InjectionPoint(methodParam), ex);</div><div class="line">					&#125;</div><div class="line">				&#125;</div></pre></td></tr></table></figure></p>
<p>看下resolveDependency()</p>
<p>到了DefaultListableBeanFactory#doResolveDependency()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">public Object doResolveDependency(DependencyDescriptor descriptor, String beanName,</div><div class="line">			Set&lt;String&gt; autowiredBeanNames, TypeConverter typeConverter) throws BeansException &#123;</div><div class="line"></div><div class="line">		InjectionPoint previousInjectionPoint = ConstructorResolver.setCurrentInjectionPoint(descriptor);</div><div class="line">		try &#123;</div><div class="line">			Object shortcut = descriptor.resolveShortcut(this);</div><div class="line">			if (shortcut != null) &#123;</div><div class="line">				return shortcut;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			Class&lt;?&gt; type = descriptor.getDependencyType();</div><div class="line">			Object value = getAutowireCandidateResolver().getSuggestedValue(descriptor);</div><div class="line">			if (value != null) &#123;</div><div class="line">				if (value instanceof String) &#123;</div><div class="line">					String strVal = resolveEmbeddedValue((String) value);</div><div class="line">					BeanDefinition bd = (beanName != null &amp;&amp; containsBean(beanName) ? getMergedBeanDefinition(beanName) : null);</div><div class="line">					value = evaluateBeanDefinitionString(strVal, bd);</div><div class="line">				&#125;</div><div class="line">				TypeConverter converter = (typeConverter != null ? typeConverter : getTypeConverter());</div><div class="line">				return (descriptor.getField() != null ?</div><div class="line">						converter.convertIfNecessary(value, type, descriptor.getField()) :</div><div class="line">						converter.convertIfNecessary(value, type, descriptor.getMethodParameter()));</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			Object multipleBeans = resolveMultipleBeans(descriptor, beanName, autowiredBeanNames, typeConverter);</div><div class="line">			if (multipleBeans != null) &#123;</div><div class="line">				return multipleBeans;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			Map&lt;String, Object&gt; matchingBeans = findAutowireCandidates(beanName, type, descriptor);</div><div class="line">			if (matchingBeans.isEmpty()) &#123;</div><div class="line">				if (isRequired(descriptor)) &#123;</div><div class="line">					raiseNoMatchingBeanFound(type, descriptor.getResolvableType(), descriptor);</div><div class="line">				&#125;</div><div class="line">				return null;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			String autowiredBeanName;</div><div class="line">			Object instanceCandidate;</div><div class="line"></div><div class="line">			if (matchingBeans.size() &gt; 1) &#123;</div><div class="line">				autowiredBeanName = determineAutowireCandidate(matchingBeans, descriptor);</div><div class="line">				if (autowiredBeanName == null) &#123;</div><div class="line">					if (isRequired(descriptor) || !indicatesMultipleBeans(type)) &#123;</div><div class="line">						return descriptor.resolveNotUnique(type, matchingBeans);</div><div class="line">					&#125;</div><div class="line">					else &#123;</div><div class="line">						// In case of an optional Collection/Map, silently ignore a non-unique case:</div><div class="line">						// possibly it was meant to be an empty collection of multiple regular beans</div><div class="line">						// (before 4.3 in particular when we didn&apos;t even look for collection beans).</div><div class="line">						return null;</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				instanceCandidate = matchingBeans.get(autowiredBeanName);</div><div class="line">			&#125;</div><div class="line">			else &#123;</div><div class="line">				// We have exactly one match.</div><div class="line">				Map.Entry&lt;String, Object&gt; entry = matchingBeans.entrySet().iterator().next();</div><div class="line">				autowiredBeanName = entry.getKey();</div><div class="line">				instanceCandidate = entry.getValue();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			if (autowiredBeanNames != null) &#123;</div><div class="line">				autowiredBeanNames.add(autowiredBeanName);</div><div class="line">			&#125;</div><div class="line">			return (instanceCandidate instanceof Class ?</div><div class="line">					//这儿又是调用beanFactory.getBean(),又到getBean的流程了</div><div class="line">					descriptor.resolveCandidate(autowiredBeanName, type, this) : instanceCandidate);</div><div class="line">		&#125;</div><div class="line">		finally &#123;</div><div class="line">			ConstructorResolver.setCurrentInjectionPoint(previousInjectionPoint);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>总结一下，没有总结归纳，就没有结果，也就没有再进一步的基础。</p>
<p>主要就是两方面的一个宏观认识</p>
<ol>
<li>bean的创建<br>IOC就是一个bean的集合，bean的创建也由他负责,那么什么时候创建，怎么创建bean？</li>
</ol>
<p>需要考虑bean的scope，一种singleton,一种prototype;还有是延迟加载属性</p>
<p>singleton就是只创建一次，会放到一个map中，以便下次使用；prototype就是每次都创建一个新的实例</p>
<ol>
<li>bean的属性注入<br>也一样，什么时候注入，怎么注入</li>
</ol>
<p>在创建bean之后，先找到需要注入的属性，也就是@Autowired注解的方法，或者属性</p>
<p>方法就需要调用，属性就需要修改值</p>
<p>整体的思路很简单，只是为了满足丰富的功能，以及符合设计原则，代码复杂得多。还需要抽丝剥茧，一层一层深入</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/spring/" rel="tag"># spring</a>
          
        </div>
      
      <! -- 添加微信图标 -->
    
    
    <div>
    <span>
    
    <br>
    </span>
    <br>
    
    <a href="http://oirwmbp4e.bkt.clouddn.com/weixin.jpg" class="fancybox" rel="article0"  style="float:left;margin-left:30%;margin-right:2px;">
    <img src="http://oirwmbp4e.bkt.clouddn.com/weixin.jpg" title="欢迎大家关注：码农戏码微信公众号" height="164px" width="164px">
    </a>
    
    </div>
    
    

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/05/19/a-coincidence-for-the-game/" rel="next" title="游戏小传一巧合入行">
                <i class="fa fa-chevron-left"></i> 游戏小传一巧合入行
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/10/a-second-try-the-game/" rel="prev" title="游戏小传二小试身手">
                游戏小传二小试身手 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        
<div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_youdao" data-cmd="youdao" title="分享到有道云笔记"></a><a href="#" class="bds_evernotecn" data-cmd="evernotecn" title="分享到印象笔记"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a>
<a href="#" class="bds_copy" data-cmd="copy" title="分享到复制网址"></a>
<a class="bds_count" data-cmd="count"></a>
</div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"24"},"share":{},"image":{"viewList":["tsina","weixin","youdao","evernotecn","tqq","qzone","renren","copy"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","weixin","youdao","evernotecn","tqq","qzone","renren","copy"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>


      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/6222636?v=3&s=460"
               alt="朱兴生" />
          <p class="site-author-name" itemprop="name">朱兴生</p>
          <p class="site-description motion-element" itemprop="description">彪悍的人生需要书写</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">31</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">17</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zhuxingsheng" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#bean创建"><span class="nav-number">1.</span> <span class="nav-text">bean创建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#属性注入"><span class="nav-number">2.</span> <span class="nav-text">属性注入</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">朱兴生</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">共85.6k字</span>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


</body>
</html>
